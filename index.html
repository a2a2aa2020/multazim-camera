<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ù…Ù„ØªØ²Ù… â€” ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙØ­Øµ</title>

  <style>
    :root{
      --bg:#050607;
      --surface: rgba(20,24,28,.72);
      --text:#F5F7FA;
      --muted: rgba(245,247,250,.72);

      --primary:#0B5FFF;
      --accent:#19C37D;
      --warning:#F59E0B;
      --danger:#EF4444;

      --radius-xl:22px;
      --radius-lg:16px;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --hairline: rgba(255,255,255,.12);

      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }

    .stage{
      position:relative;
      width:100vw;
      height:100vh;
      background:#000;
    }

    #video{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
    }

    #captureCanvas{display:none;}
    #overlay{
      position:absolute; inset:0;
      width:100%; height:100%;
      pointer-events:none;
    }

    .topbar{
      position:absolute; top:0; left:0; right:0;
      padding: calc(14px + var(--safe-top)) 16px 12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      z-index:10;
      background: linear-gradient(180deg, rgba(0,0,0,.75) 0%, rgba(0,0,0,0) 100%);
    }

    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background: linear-gradient(135deg, rgba(11,95,255,.95), rgba(25,195,125,.95));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
    }
    .titleWrap{display:flex; flex-direction:column; min-width:0;}
    .title{font-size:15px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .subtitle{font-size:12px;color:var(--muted);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .topActions{display:flex; align-items:center; gap:10px;}
    .iconBtn{
      border:1px solid var(--hairline);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      font-weight:800;
      font-size:13px;
    }
    .iconBtn:active{transform:scale(.98);}

    .hint{
      position:absolute;
      top: calc(82px + var(--safe-top));
      left:50%; transform: translateX(-50%);
      z-index:10;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--hairline);
      background: rgba(20,24,28,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 35px rgba(0,0,0,.45);
      max-width:92vw;
      text-align:center;
      font-size:14px;
    }

    .levelPill{
      position:absolute;
      top: calc(128px + var(--safe-top));
      left:50%; transform: translateX(-50%);
      z-index:10;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--hairline);
      background: rgba(20,24,28,.62);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-weight:900;
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 35px rgba(0,0,0,.45);
      max-width:92vw;
    }
    .levelDot{width:10px;height:10px;border-radius:999px;background: var(--warning);}
    .levelVals{color: var(--muted); font-weight:800;}

    .sheet{
      position:absolute; left:0; right:0; bottom:0;
      padding:10px 14px calc(14px + var(--safe-bottom));
      z-index:10;
      background: linear-gradient(0deg, rgba(0,0,0,.92) 0%, rgba(0,0,0,0) 100%);
    }

    .sheetCard{
      border: 1px solid var(--hairline);
      background: rgba(20,24,28,.56);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--radius-xl);
      padding: 12px;
      box-shadow: var(--shadow);
    }

    .types{
      display:flex; gap:10px;
      overflow-x:auto;
      padding: 6px 4px 10px;
      scrollbar-width:none;
    }
    .types::-webkit-scrollbar{display:none;}

    .chip{
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 850;
      cursor:pointer;
      white-space:nowrap;
      transition:.18s ease;
      display:flex; align-items:center; gap:8px;
    }
    .chip.active{
      background: rgba(11,95,255,.22);
      border-color: rgba(11,95,255,.65);
      box-shadow: 0 12px 30px rgba(11,95,255,.14);
    }
    .chip:active{transform:scale(.98);}

    .captureRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 6px 4px 2px;
    }

    .miniBtn{
      width:46px;height:46px;border-radius:16px;
      border:1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
    }
    .miniBtn:active{transform:scale(.98);}

    .capture{
      width:78px;height:78px;border-radius:999px;
      border:3px solid rgba(255,255,255,.92);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,0)),
        linear-gradient(135deg, rgba(11,95,255,.92), rgba(25,195,125,.92));
      box-shadow: 0 18px 45px rgba(0,0,0,.55);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:26px;
      transition: opacity .2s ease;
    }
    .capture.processing{opacity:.65;pointer-events:none;filter: grayscale(.35);}
    .capture:active{transform:scale(.98);}

    .perm{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:22px;
      background:
        radial-gradient(1000px 800px at 70% 20%, rgba(11,95,255,.22), transparent 55%),
        radial-gradient(900px 700px at 20% 70%, rgba(25,195,125,.18), transparent 55%),
        #070A0E;
      z-index:100;
    }
    .permCard{
      width: min(420px, 92vw);
      border-radius: 26px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--hairline);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 22px;
      box-shadow: var(--shadow);
      text-align:center;
    }
    .permCard h2{font-size:18px;margin-top:12px;}
    .permCard p{color: var(--muted); margin-top:10px; line-height:1.7; font-size:14px;}

    .primaryBtn{
      margin-top:16px;
      width:100%;
      border:none;
      background: var(--primary);
      color:#fff;
      font-weight:900;
      padding:14px 16px;
      border-radius:16px;
      cursor:pointer;
      box-shadow: 0 18px 35px rgba(11,95,255,.25);
      font-size:15px;
    }
    .primaryBtn:active{transform:scale(.99);}

    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.92);
      z-index:200;
      display:none;
      padding: calc(14px + var(--safe-top)) 14px calc(14px + var(--safe-bottom));
    }
    .modal.active{display:flex;flex-direction:column;gap:12px;}

    .modalHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid var(--hairline);
      background: rgba(20,24,28,.56);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .modalHeader strong{font-size:15px;}
    .closeBtn{
      border:1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      border-radius:14px;
      cursor:pointer;
    }

    .modalBody{
      flex:1;
      overflow:auto;
      border-radius:22px;
      border:1px solid var(--hairline);
      background: rgba(20,24,28,.56);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding:14px;
    }

    .preview{
      width:100%;
      border-radius:18px;
      border:1px solid var(--hairline);
      margin-bottom:14px;
      display:block;
    }

    .card{
      border-radius:18px;
      border:1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      padding:14px;
    }

    .statusRow{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .badge{
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      border:1px solid var(--hairline);
      display:inline-flex;align-items:center;gap:8px;
    }
    .badge.ok{background: rgba(25,195,125,.14); border-color: rgba(25,195,125,.45);}
    .badge.no{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.45);}
    .badge.maybe{background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.45);}

    .meta{color:var(--muted);font-size:13px;margin-top:10px;}
    .bar{
      height:10px;border-radius:999px;background: rgba(255,255,255,.10);
      margin-top:10px;overflow:hidden;border:1px solid var(--hairline);
    }
    .fill{height:100%;width:0%;transition:width 600ms ease;}

    .msg{margin-top:12px;color: rgba(245,247,250,.9);line-height:1.7;font-size:14px;}

    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .ghost{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 14px;
      border-radius:16px;
      font-weight:900;
      cursor:pointer;
    }

    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: calc(110px + var(--safe-bottom));
      z-index:300;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--hairline);
      background: rgba(20,24,28,.72);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: var(--text);
      font-size:13px;
      display:none;
      max-width:92vw;
      text-align:center;
      box-shadow: 0 16px 50px rgba(0,0,0,.55);
    }
    .toast.show{display:block;}
  </style>

  <!-- EmailJS (Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¢Ù†) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>

<body>

  <!-- Permission -->
  <div id="perm" class="perm">
    <div class="permCard">
      <div style="font-size:64px">ğŸ“·</div>
      <h2 id="permTitle">Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª Ù…Ø·Ù„ÙˆØ¨</h2>
      <p id="permDesc">
        ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„ÙØ­ØµØŒ ÙˆÙŠØ³ØªØ®Ø¯Ù… Ø­Ø³Ø§Ø³Ø§Øª Ø§Ù„Ø­Ø±ÙƒØ© (Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ©) Ù„Ø¶Ø¨Ø· Ø§Ø³ØªÙˆØ§Ø¡ Ø§Ù„Ù‡Ø§ØªÙ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·.
      </p>
      <button class="primaryBtn" id="permBtn">Ø§Ù„Ø³Ù…Ø§Ø­ ÙˆØ§Ù„Ø¨Ø¯Ø¡</button>
      <p style="margin-top:12px; font-size:12px; color: var(--muted);">
        Ø³ØªÙØ·Ù„Ø¨ Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª Ø¹Ù„Ù‰ iPhone Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.
      </p>
    </div>
  </div>

  <!-- Stage -->
  <div class="stage" id="stage" style="display:none;">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="captureCanvas"></canvas>
    <canvas id="overlay"></canvas>

    <div class="topbar">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div class="titleWrap">
          <div class="title" id="appTitle">Ù…Ù„ØªØ²Ù… â€” ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙØ­Øµ</div>
          <div class="subtitle" id="appSub">Ø®Ø¯Ù…Ø© ÙØ­Øµ Ù…ÙŠØ¯Ø§Ù†ÙŠ â€” Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</div>
        </div>
      </div>
      <div class="topActions">
        <button class="iconBtn" id="langBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©">ğŸŒ <span id="langLabel">EN</span></button>
      </div>
    </div>

    <div class="hint" id="hint">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ ÙØ­ØµÙ‡Ø§</div>

    <!-- Level indicator -->
    <div id="levelPill" class="levelPill">
      <span id="levelDot" class="levelDot"></span>
      <span id="levelText">Ø«Ø¨Ù‘Øª Ø§Ù„Ù‡Ø§ØªÙ Ù„ÙŠØµØ¨Ø­ Ù…Ø³ØªÙˆÙŠÙ‹Ø§ (Â±2Â°)</span>
      <span id="levelVals" class="levelVals"></span>
    </div>

    <div class="sheet">
      <div class="sheetCard">
        <div class="types" id="types">
          <button class="chip active" data-type="4.5">ğŸ“ Ø²ÙˆØ§ÙŠØ§ 45Â°</button>
          <button class="chip" data-type="4.7">ğŸŒ¬ï¸ Ø§Ù„ØªÙ‡ÙˆÙŠØ©</button>
          <button class="chip" data-type="5.8">ğŸ—‘ï¸ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª</button>
          <button class="chip" data-type="defects">ğŸ”§ Ø§Ù„Ø¹ÙŠÙˆØ¨</button>
        </div>

        <div class="captureRow">
          <button class="miniBtn" id="switchBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">ğŸ”„</button>
          <button class="capture" id="captureBtn" title="Ø§Ù„ØªÙ‚Ø§Ø·">ğŸ“·</button>
          <button class="miniBtn" id="stopBtn" title="Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">â»</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalHeader">
      <strong id="modalTitle">Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ</strong>
      <button class="closeBtn" id="modalClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
    </div>

    <div class="modalBody">
      <img id="preview" class="preview" alt="Captured" />
      <div class="card">
        <div class="statusRow">
          <div id="badge" class="badge maybe">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„</div>
          <div style="text-align:left">
            <div style="font-weight:900" id="ruleLabel">Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© 4.5</div>
            <div class="meta" id="confText">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©: â€”</div>
          </div>
        </div>

        <div class="bar"><div class="fill" id="fill"></div></div>
        <div class="msg" id="msg">ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©â€¦</div>

        <div class="actions">
          <button class="ghost" id="retryBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
          <button class="primaryBtn" id="newBtn" style="margin:0;">ÙØ­Øµ Ø¬Ø¯ÙŠØ¯</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // ===========================
  //  EmailJS Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¹Ø¯Ù‘Ù„Ù‡Ø§)
  // ===========================
  const EMAILJS_PUBLIC_KEY  = "PUT_YOUR_PUBLIC_KEY_HERE";
  const EMAILJS_SERVICE_ID  = "PUT_YOUR_SERVICE_ID_HERE";
  const EMAILJS_TEMPLATE_ID = "PUT_YOUR_TEMPLATE_ID_HERE";
  const EMAIL_TO = "a.alamm@datainsight.com.sa";

  // ØªÙ‡ÙŠØ¦Ø© EmailJS
  emailjs.init(EMAILJS_PUBLIC_KEY);

  // ===========================
  //  State
  // ===========================
  let stream = null;
  let currentLang = 'ar';
  let selectedType = '4.5';
  let facingMode = 'environment';
  let lastBlob = null;

  // ===========================
  //  Level / Sensors (Ø¢Ø®Ø± Ø§Ù‚ØªØ±Ø§Ø­: DeviceMotion + Gravity + Compensation + Smoothing + Stability)
  // ===========================
  // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø¹Ù†Ø¯ Ù…ÙŠÙ„ ØµØºÙŠØ± + Ø«Ø¨Ø§Øª Ù„Ø²Ù…Ù† Ù‚ØµÙŠØ±
  const LEVEL_TOL_DEG = 2;         // Â±2Â° (Ø´Ø±Ø· Ø§Ù„Ø§Ø³ØªÙˆØ§Ø¡)
  const STABILITY_TOL_DEG = 0.35;  // Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„ØªØ°Ø¨Ø°Ø¨ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø®Ù„Ø§Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± (Â±0.35Â° ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹)
  const STABILITY_MS = 450;        // Ù„Ø§Ø²Ù… ÙŠØ¨Ù‚Ù‰ Ù…Ø³ØªÙˆÙŠØ§Ù‹ ÙˆØ«Ø§Ø¨ØªØ§Ù‹ 450ms
  const SMOOTH_ALPHA = 0.18;       // Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªÙ†Ø¹ÙŠÙ… (0..1) Ø£ØµØºØ± = Ø£Ù†Ø¹Ù…/Ø£Ø¨Ø·Ø£

  let isLevel = false;
  let isStable = false;

  // Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø®Ø§Ù…/Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
  let lastPitchRaw = null, lastRollRaw = null;
  let pitchFiltered = null, rollFiltered = null;

  // Ù†Ø§ÙØ°Ø© Ù„Ù„Ø«Ø¨Ø§Øª
  let stableSince = null;
  let windowSamples = []; // {t, p, r}
  const MAX_WINDOW_MS = 650;

  // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª Ø¹Ù„Ù‰ iOS (DeviceMotion)
  async function requestMotionPermissionIfNeeded(){
    try{
      if(typeof DeviceMotionEvent !== 'undefined' &&
         typeof DeviceMotionEvent.requestPermission === 'function'){
        const res = await DeviceMotionEvent.requestPermission();
        return res === 'granted';
      }
      return true;
    }catch(e){
      console.error(e);
      return false;
    }
  }

  // Ù‚Ø±Ø§Ø¡Ø© Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø© (Ù„Ù„ØªØ¹ÙˆÙŠØ¶ Ø¹Ù† ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¬Ù‡Ø§Ø²)
  function getScreenAngle(){
    // 0 / 90 / 180 / 270
    const so = (screen.orientation && typeof screen.orientation.angle === 'number')
      ? screen.orientation.angle
      : (typeof window.orientation === 'number' ? window.orientation : 0);
    // normalize to 0..359
    return ((so % 360) + 360) % 360;
  }

  // ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ù…Ø­Ø§ÙˆØ± Ø­Ø³Ø¨ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø©
  function compensateForScreenAngle(pitch, roll){
    // pitch/roll Ù‡Ù†Ø§ Ù…Ø­Ø³ÙˆØ¨Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù…Ø­Ø§ÙˆØ± Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙŠ ÙˆØ¶Ø¹ portrait Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ.
    // Ø¹Ù†Ø¯ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø©ØŒ Ù†Ø­ÙˆÙ„ (pitch, roll) Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµØ­ÙŠØ­.
    const ang = getScreenAngle();
    let p = pitch, r = roll;

    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª Ù„ÙŠØ³Øª â€œÙÙŠØ²ÙŠØ§Ø¡ ÙƒØ§Ù…Ù„Ø©â€ Ù„ÙƒÙ†Ù‡Ø§ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©
    // 0: portrait
    // 90: landscape-right
    // 180: portrait-upside-down
    // 270: landscape-left
    if(ang === 90){
      // ØªØ¨Ø§Ø¯Ù„ Ù…Ø¹ Ø¥Ø´Ø§Ø±Ø§Øª
      const tmp = p;
      p = -r;
      r = tmp;
    } else if(ang === 180){
      p = -p;
      r = -r;
    } else if(ang === 270){
      const tmp = p;
      p = r;
      r = -tmp;
    }
    return { pitch:p, roll:r, angle: ang };
  }

  // Ø­Ø³Ø§Ø¨ pitch/roll Ù…Ù† Ù…ØªØ¬Ù‡ Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ©
  function computePitchRollFromGravity(ax, ay, az){
    // ax, ay, az Ù…Ù† accelerationIncludingGravity (m/s^2 ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹)
    // pitch: Ù…ÙŠÙ„ Ù„Ù„Ø£Ù…Ø§Ù…/Ø§Ù„Ø®Ù„Ù
    // roll: Ù…ÙŠÙ„ Ù„Ù„ÙŠÙ…ÙŠÙ†/Ø§Ù„ÙŠØ³Ø§Ø±
    // ØµÙŠØº Ø´Ø§Ø¦Ø¹Ø© Ù„Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø§Ø¡ (ØªØ¹Ù…Ù„ Ø¬ÙŠØ¯Ø§Ù‹ Ù„Ù…Ø¹Ø¸Ù… Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©)
    const roll  = Math.atan2(ay, az) * 180 / Math.PI;
    const pitch = Math.atan2(-ax, Math.sqrt(ay*ay + az*az)) * 180 / Math.PI;
    return { pitch, roll };
  }

  // ØªÙ†Ø¹ÙŠÙ… Exponential Moving Average
  function smooth(value, prev){
    if(prev === null || prev === undefined) return value;
    return prev + SMOOTH_ALPHA * (value - prev);
  }

  function updateStability(now, p, r){
    // Ø£Ø¶Ù Ø¹ÙŠÙ†Ø©
    windowSamples.push({ t: now, p, r });

    // Ø§Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…
    const cutoff = now - MAX_WINDOW_MS;
    while(windowSamples.length && windowSamples[0].t < cutoff){
      windowSamples.shift();
    }

    // Ø§Ø­Ø³Ø¨ Ø§Ù„ØªØ°Ø¨Ø°Ø¨ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© (peak-to-peak)
    let pMin = Infinity, pMax = -Infinity, rMin = Infinity, rMax = -Infinity;
    for(const s of windowSamples){
      if(s.p < pMin) pMin = s.p;
      if(s.p > pMax) pMax = s.p;
      if(s.r < rMin) rMin = s.r;
      if(s.r > rMax) rMax = s.r;
    }
    const pRange = (pMax - pMin);
    const rRange = (rMax - rMin);

    // Ù‡Ù„ Ù…Ø³ØªÙ‚Ø±ØŸ
    const stableWindow = (pRange <= STABILITY_TOL_DEG) && (rRange <= STABILITY_TOL_DEG);
    return { stableWindow, pRange, rRange };
  }

  function setLevelState(pitchDeg, rollDeg, meta){
    // Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªÙˆØ§Ø¡
    isLevel = (Math.abs(pitchDeg) <= LEVEL_TOL_DEG) && (Math.abs(rollDeg) <= LEVEL_TOL_DEG);

    // Ø´Ø±ÙˆØ· Ø§Ù„Ø«Ø¨Ø§Øª (Ù…Ø¹ Ù†Ø§ÙØ°Ø© Ø²Ù…Ù†ÙŠØ©)
    const now = performance.now();
    const { stableWindow, pRange, rRange } = updateStability(now, pitchDeg, rollDeg);

    // Ù†Ø¹ØªØ¨Ø± â€œÙ…Ø³ØªÙ‚Ø±â€ Ø¥Ø°Ø§ Ù…Ø³ØªÙˆÙŠ + Ù†Ø§ÙØ°Ø© Ù…Ø³ØªÙ‚Ø±Ø© Ù„Ù…Ø¯Ø© STABILITY_MS
    if(isLevel && stableWindow){
      if(stableSince === null) stableSince = now;
      isStable = (now - stableSince) >= STABILITY_MS;
    } else {
      stableSince = null;
      isStable = false;
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateLevelUI(pitchDeg, rollDeg, {
      ...meta,
      pRange, rRange,
      stableWindow
    });
  }

  function updateLevelUI(pitchDeg, rollDeg, meta){
    const dot = document.getElementById('levelDot');
    const text = document.getElementById('levelText');
    const vals = document.getElementById('levelVals');
    const L = TT[currentLang];

    const p = Math.round(pitchDeg * 10) / 10;
    const r = Math.round(rollDeg * 10) / 10;

    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ÙÙŠØ¯Ø©: Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø© + Ù…Ø¯Ù‰ Ø§Ù„ØªØ°Ø¨Ø°Ø¨
    const ang = meta && typeof meta.angle === 'number' ? meta.angle : getScreenAngle();
    const pr = meta && typeof meta.pRange === 'number' ? meta.pRange : 0;
    const rr = meta && typeof meta.rRange === 'number' ? meta.rRange : 0;

    vals.textContent = `P:${p}Â°  R:${r}Â°  â†»${ang}Â°`;

    // Ø§Ù„Ø­Ø§Ù„Ø©: Ù†Ø±ÙŠØ¯ "Ù…Ø³ØªÙˆÙ + Ø«Ø§Ø¨Øª"
    if(isStable){
      dot.style.background = 'var(--accent)';
      text.textContent = L.levelOkStable;
      enableCapture();
    } else if(isLevel){
      dot.style.background = 'var(--warning)';
      text.textContent = (currentLang==='ar')
        ? `Ø¬ÙŠØ¯â€¦ Ø«Ø¨Ù‘Øª Ù„Ø­Ø¸Ø© (${Math.round(STABILITY_MS/100)/10}s) | Ø§Ù‡ØªØ²Ø§Ø² P:${(pr).toFixed(2)} R:${(rr).toFixed(2)}`
        : `Almostâ€¦ hold steady (${Math.round(STABILITY_MS/100)/10}s) | jitter P:${(pr).toFixed(2)} R:${(rr).toFixed(2)}`;
      disableCapture();
    } else {
      dot.style.background = 'var(--danger)';
      text.textContent = L.levelHold(LEVEL_TOL_DEG);
      disableCapture();
    }
  }

  // Ù…Ø¹Ø§Ù„Ø¬ DeviceMotion
  function handleDeviceMotion(e){
    const ag = e.accelerationIncludingGravity;
    if(!ag) return;

    // Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ØªØ¹Ø·ÙŠ null Ø£Ø­ÙŠØ§Ù†Ø§Ù‹
    const ax = (typeof ag.x === 'number') ? ag.x : 0;
    const ay = (typeof ag.y === 'number') ? ag.y : 0;
    const az = (typeof ag.z === 'number') ? ag.z : 0;

    const { pitch, roll } = computePitchRollFromGravity(ax, ay, az);

    // Ø­ÙØ¸ Ø§Ù„Ø®Ø§Ù…
    lastPitchRaw = pitch;
    lastRollRaw = roll;

    // ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†
    const comp = compensateForScreenAngle(pitch, roll);

    // ØªÙ†Ø¹ÙŠÙ…
    pitchFiltered = smooth(comp.pitch, pitchFiltered);
    rollFiltered  = smooth(comp.roll,  rollFiltered);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    setLevelState(pitchFiltered, rollFiltered, { angle: comp.angle });
  }

  let motionListening = false;

  async function enableMotionSensors(){
    const ok = await requestMotionPermissionIfNeeded();
    if(!ok){
      toast(currentLang==='ar' ? 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª.' : 'Motion permission denied.');
      disableCapture();
      return false;
    }
    if(!motionListening){
      window.addEventListener('devicemotion', handleDeviceMotion, { passive:true });
      motionListening = true;
    }
    return true;
  }

  function removeMotionSensors(){
    if(motionListening){
      window.removeEventListener('devicemotion', handleDeviceMotion);
      motionListening = false;
    }
    isLevel = false;
    isStable = false;
    stableSince = null;
    windowSamples = [];
    lastPitchRaw = lastRollRaw = null;
    pitchFiltered = rollFiltered = null;
  }

  // ===========================
  //  Translations
  // ===========================
  const TT = {
    ar: {
      appTitle: 'Ù…Ù„ØªØ²Ù… â€” ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙØ­Øµ',
      appSub: 'Ø®Ø¯Ù…Ø© ÙØ­Øµ Ù…ÙŠØ¯Ø§Ù†ÙŠ â€” Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©',
      hint: 'ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ ÙØ­ØµÙ‡Ø§',
      modalTitle: 'Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ',
      retry: 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„',
      newScan: 'ÙØ­Øµ Ø¬Ø¯ÙŠØ¯',
      close: 'Ø¥ØºÙ„Ø§Ù‚ âœ•',
      lang: 'EN',
      rule: (x)=> x==='defects' ? 'ÙØ­Øµ Ø§Ù„Ø¹ÙŠÙˆØ¨' : `Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ${x}`,
      levelHold: (tol)=> `Ø¹Ø¯Ù‘Ù„ ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø§ØªÙ Ø­ØªÙ‰ ÙŠØµØ¨Ø­ Ù‚Ø±ÙŠØ¨Ù‹Ø§ Ù…Ù† Ø§Ù„Ø§Ø³ØªÙˆØ§Ø¡ (Â±${tol}Â°)`,
      levelOkStable: 'âœ… Ù…Ø³ØªÙˆÙ ÙˆØ«Ø§Ø¨Øª â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·',
      emailSent: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ âœ…',
      emailFail: 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ EmailJS.',
      cameraFail: 'ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†.',
      captureFail: 'ÙØ´Ù„ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©.',
      needStable: 'Ø«Ø¨Ù‘Øª Ø§Ù„Ù‡Ø§ØªÙ Ø­ØªÙ‰ ÙŠØµØ¨Ø­ Ù…Ø³ØªÙˆÙŠÙ‹Ø§ ÙˆØ«Ø§Ø¨ØªÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·.'
    },
    en: {
      appTitle: 'Multazim â€” Inspection Camera',
      appSub: 'Field inspection service â€” Beta',
      hint: 'Point the camera at the area to inspect',
      modalTitle: 'Inspection Result',
      retry: 'Retry',
      newScan: 'New Scan',
      close: 'Close âœ•',
      lang: 'AR',
      rule: (x)=> x==='defects' ? 'Defects Scan' : `Rule ${x}`,
      levelHold: (tol)=> `Adjust device to be near level (Â±${tol}Â°)`,
      levelOkStable: 'âœ… Level & steady â€” you can capture',
      emailSent: 'Result emailed âœ…',
      emailFail: 'Email failed. Check EmailJS setup.',
      cameraFail: 'Unable to start camera. Please grant permission.',
      captureFail: 'Capture failed.',
      needStable: 'Hold device level and steady before capturing.'
    }
  };

  // ===========================
  //  Helpers
  // ===========================
  function toast(msg){
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(()=> el.classList.remove('show'), 2400);
  }

  function setTexts(){
    const L = TT[currentLang];
    document.documentElement.lang = currentLang;
    document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';

    document.getElementById('appTitle').textContent = L.appTitle;
    document.getElementById('appSub').textContent = L.appSub;
    document.getElementById('hint').textContent = L.hint;

    document.getElementById('modalTitle').textContent = L.modalTitle;
    document.getElementById('retryBtn').textContent = L.retry;
    document.getElementById('newBtn').textContent = L.newScan;
    document.getElementById('modalClose').textContent = L.close;
    document.getElementById('langLabel').textContent = L.lang;

    document.getElementById('ruleLabel').textContent = L.rule(selectedType);

    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const levelText = document.getElementById('levelText');
    if(isStable) levelText.textContent = L.levelOkStable;
    else levelText.textContent = L.levelHold(LEVEL_TOL_DEG);
  }

  function disableCapture(){
    const captureBtn = document.getElementById('captureBtn');
    captureBtn.style.opacity = '.55';
    captureBtn.style.pointerEvents = 'none';
  }
  function enableCapture(){
    const captureBtn = document.getElementById('captureBtn');
    captureBtn.style.opacity = '1';
    captureBtn.style.pointerEvents = 'auto';
  }

  // ===========================
  //  Camera
  // ===========================
  async function startCamera(){
    stopCamera();
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode, width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });

      const video = document.getElementById('video');
      video.srcObject = stream;

      document.getElementById('perm').style.display = 'none';
      document.getElementById('stage').style.display = 'block';

      await video.play();

      resizeOverlay();
      drawLoop();

      // Motion sensors
      disableCapture();              // Ù‚ÙÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ
      await enableMotionSensors();   // ÙŠÙØªØ­ ÙÙ‚Ø· Ø¹Ù†Ø¯ "Ù…Ø³ØªÙˆÙ ÙˆØ«Ø§Ø¨Øª"

    }catch(e){
      toast(TT[currentLang].cameraFail);
      console.error(e);
    }
  }

  function stopCamera(){
    if(stream){
      stream.getTracks().forEach(tr=> tr.stop());
      stream = null;
    }
  }

  // ===========================
  //  Overlay drawing
  // ===========================
  function resizeOverlay(){
    const overlay = document.getElementById('overlay');
    const rect = overlay.getBoundingClientRect();
    overlay.width = Math.floor(rect.width * devicePixelRatio);
    overlay.height = Math.floor(rect.height * devicePixelRatio);
  }

  function drawGuide(ctx, type){
    const w = ctx.canvas.width;
    const h = ctx.canvas.height;
    const cx = w/2, cy = h/2;

    ctx.clearRect(0,0,w,h);

    ctx.strokeStyle = 'rgba(11,95,255,.95)';
    ctx.lineWidth = 4;
    ctx.shadowColor = 'rgba(0,0,0,.55)';
    ctx.shadowBlur = 8;

    if(type === '4.5'){
      const size = Math.min(w,h)*0.38;
      ctx.beginPath();
      ctx.moveTo(cx - size/2, cy);
      ctx.lineTo(cx + size/2, cy);
      ctx.moveTo(cx, cy - size/2);
      ctx.lineTo(cx, cy + size/2);
      ctx.moveTo(cx - size/3, cy - size/3);
      ctx.lineTo(cx + size/3, cy + size/3);
      ctx.stroke();

      ctx.shadowBlur = 0;
      ctx.fillStyle = 'rgba(245,247,250,.92)';
      ctx.font = '900 28px system-ui, Arial';
      ctx.textAlign = 'center';
      ctx.fillText('45Â°', cx, cy - size/2 - 18);
    } else if(type === '4.7'){
      const rw = w*0.62;
      const rh = h*0.36;
      ctx.strokeRect(cx - rw/2, cy - rh/2, rw, rh);
    } else if(type === '5.8'){
      const r = Math.min(w,h)*0.26;
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.stroke();
    } else {
      ctx.strokeStyle = 'rgba(11,95,255,.25)';
      ctx.lineWidth = 2;
      for(let i=1;i<4;i++){
        ctx.beginPath();
        ctx.moveTo(w*i/4, 0);
        ctx.lineTo(w*i/4, h);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, h*i/4);
        ctx.lineTo(w, h*i/4);
        ctx.stroke();
      }
    }
  }

  let rafId = null;
  function drawLoop(){
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const loop = ()=>{
      drawGuide(ctx, selectedType);
      rafId = requestAnimationFrame(loop);
    };
    loop();
  }

  function stopOverlayLoop(){
    if(rafId) cancelAnimationFrame(rafId);
    rafId = null;
  }

  function setType(type){
    selectedType = type;
    document.querySelectorAll('.chip').forEach(b=>{
      b.classList.toggle('active', b.dataset.type===type);
    });
    setTexts();
  }

  // ===========================
  //  Capture & Analyze (Ù…Ø­Ø§ÙƒØ§Ø©)
  // ===========================
  async function capture(){
    // Ù‚ÙÙ„ Ù†Ù‡Ø§Ø¦ÙŠ
    if(!isStable){
      toast(TT[currentLang].needStable);
      return;
    }

    const btn = document.getElementById('captureBtn');
    btn.classList.add('processing');

    try{
      const video = document.getElementById('video');
      const canvas = document.getElementById('captureCanvas');
      const ctx = canvas.getContext('2d');

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      lastBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.86));
      const url = URL.createObjectURL(lastBlob);
      document.getElementById('preview').src = url;

      openModalLoading();

      setTimeout(async ()=>{
        const result = mockResult();
        showResult(result);

        // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø©
        try{
          await sendResultEmail(result);
          toast(TT[currentLang].emailSent);
        }catch(err){
          console.error(err);
          toast(TT[currentLang].emailFail);
        }
      }, 900);

    }catch(e){
      toast(TT[currentLang].captureFail);
      console.error(e);
    }finally{
      btn.classList.remove('processing');
    }
  }

  function openModalLoading(){
    const L = TT[currentLang];
    document.getElementById('modal').classList.add('active');
    document.getElementById('badge').className = 'badge maybe';
    document.getElementById('badge').textContent = currentLang==='ar' ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„' : 'â³ Analyzing';
    document.getElementById('confText').textContent = currentLang==='ar' ? 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©: â€”' : 'Confidence: â€”';
    document.getElementById('fill').style.width = '0%';
    document.getElementById('fill').style.background = 'linear-gradient(90deg, rgba(245,158,11,.9), rgba(11,95,255,.9))';
    document.getElementById('msg').textContent = currentLang==='ar' ? 'ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©â€¦' : 'Processing the imageâ€¦';
    document.getElementById('ruleLabel').textContent = L.rule(selectedType);
  }

  function closeModal(){
    document.getElementById('modal').classList.remove('active');
    const img = document.getElementById('preview');
    if(img.src.startsWith('blob:')) URL.revokeObjectURL(img.src);
    img.src = '';
  }

  function mockResult(){
    const pick = Math.random();
    if(pick < 0.45){
      return { status:'compliant', confidence: 92 + Math.floor(Math.random()*6),
        msgAr:'ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…ÙˆØ§ØµÙØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© â€” Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…Ø¹Ø§ÙŠÙŠØ±.',
        msgEn:'Required specification detected â€” compliant.' };
    } else if(pick < 0.8){
      return { status:'non-compliant', confidence: 78 + Math.floor(Math.random()*10),
        msgAr:'ØªÙ… Ø±ØµØ¯ Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© â€” ÙŠÙ„Ø²Ù… Ø¥Ø¬Ø±Ø§Ø¡ ØªØµØ­ÙŠØ­ÙŠ.',
        msgEn:'Non-compliance detected â€” corrective action required.' };
    }
    return { status:'uncertain', confidence: 55 + Math.floor(Math.random()*18),
      msgAr:'ØºÙŠØ± Ù‚Ø§Ø¯Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨ÙˆØ¶ÙˆØ­ â€” ÙŠÙÙ†ØµØ­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ù…Ø¹ Ø¥Ø¶Ø§Ø¡Ø© Ø£ÙØ¶Ù„.',
      msgEn:'Unable to determine â€” retake with better lighting.' };
  }

  function showResult(r){
    const fill = document.getElementById('fill');
    const badge = document.getElementById('badge');
    const confText = document.getElementById('confText');
    const msg = document.getElementById('msg');

    const map = {
      compliant: { cls:'ok', color:'linear-gradient(90deg, rgba(25,195,125,.95), rgba(11,95,255,.65))',
        labelAr:'âœ“ Ù…Ø·Ø§Ø¨Ù‚', labelEn:'âœ“ Compliant' },
      'non-compliant': { cls:'no', color:'linear-gradient(90deg, rgba(239,68,68,.95), rgba(245,158,11,.55))',
        labelAr:'âœ• ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚', labelEn:'âœ• Non-Compliant' },
      uncertain: { cls:'maybe', color:'linear-gradient(90deg, rgba(245,158,11,.95), rgba(11,95,255,.55))',
        labelAr:'ØŸ ØºÙŠØ± Ù…Ø¤ÙƒØ¯', labelEn:'ï¼Ÿ Uncertain' }
    };

    const m = map[r.status];
    badge.className = 'badge ' + m.cls;
    badge.textContent = (currentLang==='ar') ? m.labelAr : m.labelEn;

    confText.textContent = (currentLang==='ar')
      ? `Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©: ${r.confidence}%`
      : `Confidence: ${r.confidence}%`;

    fill.style.background = m.color;
    requestAnimationFrame(()=> { fill.style.width = r.confidence + '%'; });

    msg.textContent = (currentLang==='ar') ? r.msgAr : r.msgEn;
  }

  // ===========================
  //  EmailJS: Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ
  // ===========================
  async function sendResultEmail(result){
    // Ù„Ø§ ØªØ­Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¯ÙˆÙ† Ù…ÙØ§ØªÙŠØ­
    if(!EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY.includes("PUT_") ||
       !EMAILJS_SERVICE_ID || EMAILJS_SERVICE_ID.includes("PUT_") ||
       !EMAILJS_TEMPLATE_ID || EMAILJS_TEMPLATE_ID.includes("PUT_")){
      throw new Error("EmailJS keys not set");
    }

    const L = TT[currentLang];
    const ts = new Date();

    // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù„Ø£Ù†Ù‡Ø§ â€œØ£Ù‚Ø±Ø¨ Ù„Ù„Ø­Ù‚ÙŠÙ‚Ø©â€
    const p = (typeof pitchFiltered === 'number') ? pitchFiltered : lastPitchRaw;
    const r = (typeof rollFiltered === 'number') ? rollFiltered : lastRollRaw;

    const payload = {
      to_email: EMAIL_TO,
      rule: L.rule(selectedType),
      rule_code: selectedType,
      status: result.status,
      confidence: result.confidence + '%',
      message: (currentLang==='ar') ? result.msgAr : result.msgEn,
      pitch: (typeof p === 'number') ? p.toFixed(2) + 'Â°' : 'N/A',
      roll:  (typeof r === 'number') ? r.toFixed(2) + 'Â°' : 'N/A',
      screen_angle: String(getScreenAngle()),
      stable: isStable ? 'YES' : 'NO',
      timestamp: ts.toLocaleString(),
      lang: currentLang.toUpperCase()
    };

    return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, payload);
  }

  // ===========================
  //  Events
  // ===========================
  document.getElementById('permBtn').addEventListener('click', startCamera);

  document.getElementById('langBtn').addEventListener('click', ()=>{
    currentLang = (currentLang==='ar') ? 'en' : 'ar';
    setTexts();
  });

  document.getElementById('types').addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip');
    if(!btn) return;
    setType(btn.dataset.type);
  });

  document.getElementById('captureBtn').addEventListener('click', capture);

  document.getElementById('retryBtn').addEventListener('click', ()=>{
    openModalLoading();
    setTimeout(async ()=>{
      const result = mockResult();
      showResult(result);
      try{
        await sendResultEmail(result);
        toast(TT[currentLang].emailSent);
      }catch(err){
        console.error(err);
        toast(TT[currentLang].emailFail);
      }
    }, 800);
  });

  document.getElementById('newBtn').addEventListener('click', closeModal);
  document.getElementById('modalClose').addEventListener('click', closeModal);

  document.getElementById('stopBtn').addEventListener('click', ()=>{
    stopOverlayLoop();
    stopCamera();
    removeMotionSensors();
    document.getElementById('stage').style.display = 'none';
    document.getElementById('perm').style.display = 'flex';
    disableCapture();
    toast(currentLang==='ar' ? 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.' : 'Camera stopped.');
  });

  document.getElementById('switchBtn').addEventListener('click', async ()=>{
    facingMode = (facingMode === 'environment') ? 'user' : 'environment';
    toast(currentLang==='ar'
      ? (facingMode==='environment' ? 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©' : 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©')
      : (facingMode==='environment' ? 'Rear camera' : 'Front camera')
    );
    removeMotionSensors();
    await startCamera();
  });

  window.addEventListener('resize', resizeOverlay);

  // ===========================
  //  Init
  // ===========================
  disableCapture();
  setTexts();
</script>

</body>
</html>
