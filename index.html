<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ù†Ø¸Ø§Ù… Ù…Ù„ØªØ²Ù… - ÙØ­Øµ Ø§Ù„ØºØ±Ù</title>
    <style>
        :root { --primary: #0052CC; --success: #27AE60; --danger: #E74C3C; --bg: #FFFFFF; --text: #1E293B; --safe-top: env(safe-area-inset-top); }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100dvh; display: flex; flex-direction: column; }
        
        .screen { display: none; flex-direction: column; width: 100%; padding: 20px; padding-top: calc(var(--safe-top) + 20px); }
        .active-screen { display: flex; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .room-entry { background: #F8FAFC; padding: 15px; border-radius: 12px; border: 1px solid #E2E8F0; margin-bottom: 15px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .input-grid input { padding: 8px; border: 1px solid #CBD5E1; border-radius: 6px; width: 100%; }
        
        /* Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        .camera-container { position: relative; width: 100%; height: 350px; background: #000; border-radius: 15px; overflow: hidden; margin: 15px 0; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #overlay { position: absolute; inset: 0; pointer-events: none; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 15px; }
        .btn-add { background: #E2E8F0; color: var(--text); margin-bottom: 20px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        
        /* Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
        .violation-card { border: 2px solid var(--danger); border-radius: 12px; padding: 15px; margin-bottom: 15px; background: #FFF5F5; }
        .violation-img { width: 100%; height: 150px; background: #ddd; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666; }
    </style>
</head>
<body>

    <div id="setupScreen" class="screen active-screen">
        <h2 style="margin-bottom: 10px;">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ­Øµ</h2>
        <input type="number" id="crNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px;">
        
        <div id="roomsContainer">
            </div>
        
        <button class="btn btn-add" onclick="addRoom()">â• Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <button class="btn btn-primary" onclick="startInspection()">Ø§Ø¨Ø¯Ø£ ÙØ­Øµ Ø§Ù„Ù…Ù†Ø´Ø£Ø©</button>
    </div>

    <div id="inspectionScreen" class="screen">
        <h3 id="currentLocation">Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© - ÙØ­Øµ Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†</h3>
        <p id="taskProgress" style="font-size: 14px; color: var(--primary); margin-bottom: 10px;">Ø§Ù„Ø¹Ù†ØµØ± 1 Ù…Ù† 3</p>
        
        <div class="camera-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="overlay"></canvas>
        </div>

        <button class="btn btn-primary" onclick="processCheck()">ğŸ“¸ ØªÙˆØ«ÙŠÙ‚ ÙˆØªØ­Ù„ÙŠÙ„</button>
    </div>

    <div id="reportScreen" class="screen">
        <h2 style="color: var(--danger); text-align: center;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ØµÙˆØ¯Ø©</h2>
        <p id="reportCR" style="text-align: center; margin-bottom: 20px;"></p>
        <div id="violationList"></div>
        <button class="btn btn-primary" onclick="location.reload()">ÙØ­Øµ Ø¬Ø¯ÙŠØ¯</button>
    </div>

<script>
    let roomsData = [];
    let currentRoomIdx = 0;
    let currentTaskType = 'walls'; // walls, bins, vents, floors
    let taskCounter = 1;
    let violations = [];

    function addRoom() {
        const id = Date.now();
        const html = `
            <div class="room-entry" id="room_${id}">
                <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ù…Ø·Ø¨Ø® Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)" class="r-name" style="font-weight:bold; margin-bottom:10px;">
                <div class="input-grid">
                    <div><label>Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†:</label><input type="number" class="r-walls" value="4"></div>
                    <div><label>Ø§Ù„Ø³Ù„Ø§Ù„:</label><input type="number" class="r-bins" value="1"></div>
                    <div><label>Ø§Ù„ØªÙ‡ÙˆÙŠØ©:</label><input type="number" class="r-vents" value="1"></div>
                    <div><label>Ø§Ù„Ø£Ø±Ø¶ÙŠØ§Øª:</label><input type="number" class="r-floors" value="1"></div>
                </div>
            </div>`;
        document.getElementById('roomsContainer').insertAdjacentHTML('beforeend', html);
    }

    // Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
    addRoom();

    async function startInspection() {
        if(!document.getElementById('crNumber').value) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„");
        
        const roomDivs = document.querySelectorAll('.room-entry');
        roomDivs.forEach(div => {
            roomsData.push({
                name: div.querySelector('.r-name').value || "ØºØ±ÙØ© ØºÙŠØ± Ù…Ø³Ù…Ù‰",
                walls: parseInt(div.querySelector('.r-walls').value),
                bins: parseInt(div.querySelector('.r-bins').value),
                vents: parseInt(div.querySelector('.r-vents').value),
                floors: parseInt(div.querySelector('.r-floors').value)
            });
        });

        document.getElementById('setupScreen').classList.remove('active-screen');
        document.getElementById('inspectionScreen').classList.add('active-screen');
        
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('video').srcObject = stream;
        updateUI();
    }

    function updateUI() {
        const room = roomsData[currentRoomIdx];
        const taskNames = { walls: 'Ø§Ù„Ø¬Ø¯Ø±Ø§Ù† (Ø§Ù„Ø²ÙˆØ§ÙŠØ§)', bins: 'Ø³Ù„Ø§Ù„ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª', vents: 'ÙØªØ­Ø§Øª Ø§Ù„ØªÙ‡ÙˆÙŠØ©', floors: 'Ø§Ù„Ø£Ø±Ø¶ÙŠØ§Øª' };
        document.getElementById('currentLocation').innerText = `${room.name} - ${taskNames[currentTaskType]}`;
        document.getElementById('taskProgress').innerText = `Ø§Ù„Ø¹Ù†ØµØ± ${taskCounter} Ù…Ù† ${room[currentTaskType]}`;
    }

    function processCheck() {
        const isPass = Math.random() > 0.4; // Ù…Ø­Ø§ÙƒØ§Ø© ÙØ­Øµ AI
        const room = roomsData[currentRoomIdx];

        if (!isPass) {
            violations.push({
                roomName: room.name,
                type: currentTaskType,
                desc: `Ù…Ø®Ø§Ù„ÙØ© ÙÙŠ ${currentTaskType} Ø±Ù‚Ù… ${taskCounter}`
            });
        }

        // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„ØºØ±Ù
        if (taskCounter < room[currentTaskType]) {
            taskCounter++;
        } else {
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù†ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØºØ±ÙØ©
            const types = ['walls', 'bins', 'vents', 'floors'];
            let typeIdx = types.indexOf(currentTaskType);
            
            if (typeIdx < types.length - 1) {
                currentTaskType = types[typeIdx + 1];
                taskCounter = 1;
            } else {
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØºØ±ÙØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
                if (currentRoomIdx < roomsData.length - 1) {
                    currentRoomIdx++;
                    currentTaskType = 'walls';
                    taskCounter = 1;
                    alert("Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØºØ±ÙØ© Ø§Ù„ØªØ§Ù„ÙŠØ©: " + roomsData[currentRoomIdx].name);
                } else {
                    return showFinalReport();
                }
            }
        }
        updateUI();
    }

    function showFinalReport() {
        document.getElementById('inspectionScreen').classList.remove('active-screen');
        document.getElementById('reportScreen').classList.add('active-screen');
        document.getElementById('reportCR').innerText = "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ: " + document.getElementById('crNumber').value;

        const list = document.getElementById('violationList');
        if (violations.length === 0) {
            list.innerHTML = "<p style='text-align:center; color:green;'>âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§ØªØŒ Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ù…Ù…ØªØ«Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.</p>";
            return;
        }

        list.innerHTML = violations.map(v => `
            <div class="violation-card">
                <strong>ğŸ“ ${v.roomName}</strong><br>
                <span>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©: ${v.desc}</span>
                <div class="violation-img">[ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ù…Ù„ØªÙ‚Ø·Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§]</div>
            </div>
        `).join('');
    }
</script>
</body>
</html>
