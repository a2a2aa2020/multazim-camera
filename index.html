<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>نظام ملتزم - الفحص الشامل</title>
    <style>
        :root { 
            --primary: #0052CC; --success: #27AE60; --danger: #E74C3C;
            --bg: #FFFFFF; --card-bg: #F8FAFC; --text: #1E293B;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        .screen { display: none; flex-direction: column; height: 100%; width: 100%; background: var(--bg); position: absolute; inset: 0; padding: 20px; padding-top: calc(var(--safe-top) + 20px); }
        .active-screen { display: flex; }

        /* شاشة الإدخال */
        .setup-card { background: var(--card-bg); padding: 25px; border-radius: 20px; border: 1px solid #E2E8F0; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        .input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #CBD5E1; font-size: 16px; }

        /* واجهة الكاميرا */
        .camera-section { flex: 1; position: relative; margin: 15px 0; border-radius: 20px; overflow: hidden; background: #000; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .counter-badge { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; z-index: 10; }

        /* الأزرار */
        .btn { padding: 16px; border-radius: 12px; border: none; font-weight: bold; width: 100%; font-size: 16px; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-disabled { background: #E2E8F0; color: #94A3B8; cursor: not-allowed; }
        
        .progress-bar { height: 6px; background: #E2E8F0; border-radius: 3px; margin-bottom: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: 0.3s; }
    </style>
</head>
<body>

    <div id="setupScreen" class="screen active-screen">
        <h2 style="margin-bottom: 10px;">إعداد جولة الفحص</h2>
        <p style="color: #64748B; margin-bottom: 25px;">يرجى تحديد عدد العناصر في المطعم لبدء المسح الشامل</p>
        
        <div class="setup-card">
            <div class="input-group">
                <label>عدد الغرف (مطابخ، مستودعات، إلخ):</label>
                <input type="number" id="count_rooms" value="1" min="1">
            </div>
            <div class="input-group">
                <label>إجمالي عدد سلال النفايات:</label>
                <input type="number" id="count_bins" value="2" min="1">
            </div>
            <div class="input-group">
                <label>إجمالي عدد فتحات التهوية:</label>
                <input type="number" id="count_vents" value="2" min="1">
            </div>
            <button class="btn btn-primary" onclick="startFullInspection()">بدء الفحص الشامل</button>
        </div>
    </div>

    <div id="inspectionScreen" class="screen" style="padding: 0;">
        <div style="padding: 15px; padding-top: calc(var(--safe-top) + 10px);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 id="currentTaskTitle">فحص الغرف (الزوايا)</h4>
                <span id="taskProgressText" style="font-size: 12px; font-weight: bold; color: var(--primary);">0 / 0</span>
            </div>
            <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        </div>

        <div class="camera-section">
            <div id="badge" class="counter-badge">بانتظار التعرف...</div>
            <video id="video" autoplay playsinline muted></video>
        </div>

        <div style="padding: 20px; padding-bottom: calc(var(--safe-bottom) + 20px);">
            <p id="aiHint" style="text-align: center; font-size: 13px; color: #64748B; margin-bottom: 15px;">وجه الكاميرا نحو الهدف...</p>
            <button id="actionBtn" class="btn btn-primary" onclick="captureAndNext()">توثيق العنصر الحالي</button>
            <button id="finishBtn" class="btn btn-disabled" style="margin-top: 10px;" disabled onclick="showFinalReport()">إصدار التقرير النهائي</button>
        </div>
    </div>

    <div id="reportScreen" class="screen">
        <h2 style="text-align: center; margin-bottom: 20px;">التقرير الرقابي المكتمل</h2>
        <div id="finalSummary" style="background: #F0FDF4; padding: 15px; border-radius: 12px; margin-bottom: 20px; font-size: 14px;"></div>
        <div id="logsList"></div>
        <button class="btn btn-primary" style="margin-top: 20px;" onclick="location.reload()">جولة جديدة</button>
    </div>

<script>
    let counts = { rooms: 0, bins: 0, vents: 0 };
    let currentCategory = 'rooms'; // الترتيب: غرف -> سلال -> فتحات
    let categoryIndex = 0;
    let categoryOrder = ['rooms', 'bins', 'vents'];
    let logs = [];
    let completedInCurrent = 0;

    function startFullInspection() {
        counts.rooms = parseInt(document.getElementById('count_rooms').value);
        counts.bins = parseInt(document.getElementById('count_bins').value);
        counts.vents = parseInt(document.getElementById('count_vents').value);

        document.getElementById('setupScreen').classList.remove('active-screen');
        document.getElementById('inspectionScreen').classList.add('active-screen');
        
        updateUI();
        initCamera();
    }

    async function initCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('video').srcObject = stream;
    }

    function updateUI() {
        const cat = categoryOrder[categoryIndex];
        const titles = { rooms: "فحص الغرف (الزوايا)", bins: "فحص سلال النفايات", vents: "فحص فتحات التهوية" };
        
        document.getElementById('currentTaskTitle').innerText = titles[cat];
        document.getElementById('taskProgressText').innerText = `${completedInCurrent} / ${counts[cat]}`;
        
        // حساب النسبة الكلية للتقدم
        const totalToWash = counts.rooms + counts.bins + counts.vents;
        const totalDone = logs.length;
        const percent = (totalDone / totalToWash) * 100;
        document.getElementById('progressFill').style.width = percent + '%';

        if (totalDone === totalToWash) {
            document.getElementById('actionBtn').classList.add('btn-disabled');
            document.getElementById('actionBtn').disabled = true;
            document.getElementById('finishBtn').className = 'btn btn-primary';
            document.getElementById('finishBtn').disabled = false;
            document.getElementById('aiHint').innerText = "✅ اكتملت جميع فحوصات المطعم";
        }
    }

    function captureAndNext() {
        const cat = categoryOrder[categoryIndex];
        
        // توثيق النتيجة
        logs.push({
            category: cat,
            itemNum: completedInCurrent + 1,
            isPass: Math.random() > 0.2, // محاكاة نتيجة
            time: new Date().toLocaleTimeString('ar-SA')
        });

        completedInCurrent++;

        // الانتقال للفئة التالية إذا اكتملت الحالية
        if (completedInCurrent >= counts[cat]) {
            if (categoryIndex < categoryOrder.length - 1) {
                categoryIndex++;
                completedInCurrent = 0;
                alert(`اكتمل فحص ${cat}. انتقل الآن إلى الفئة التالية.`);
            }
        }

        updateUI();
    }

    function showFinalReport() {
        document.getElementById('inspectionScreen').classList.remove('active-screen');
        document.getElementById('reportScreen').classList.add('active-screen');

        const passCount = logs.filter(l => l.isPass).length;
        document.getElementById('finalSummary').innerText = `تم فحص ${logs.length} عنصر في المطعم بالكامل. (المطابق: ${passCount} | المخالف: ${logs.length - passCount})`;

        document.getElementById('logsList').innerHTML = logs.map(l => `
            <div style="padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                <span>${getArabicCat(l.category)} #${l.itemNum}</span>
                <span style="color: ${l.isPass ? 'green' : 'red'}">${l.isPass ? '✅ مطابق' : '❌ مخالف'}</span>
            </div>
        `).join('');
    }

    function getArabicCat(c) {
        return {rooms: 'غرفة', bins: 'سلة', vents: 'فتحة تهوية'}[c];
    }
</script>
</body>
</html>
