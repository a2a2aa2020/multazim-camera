<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ù†Ø¸Ø§Ù… Ù…Ù„ØªØ²Ù… - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</title>
    <style>
        :root { 
            --primary: #0052CC; --success: #27AE60; --danger: #E74C3C; 
            --bg: #FFFFFF; --safe-top: env(safe-area-inset-top); 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
        body { background: white; color: #1E293B; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; padding: 20px; padding-top: calc(var(--safe-top) + 20px); background: white; overflow-y: auto; }
        .active-screen { display: flex; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        .room-entry { background: #F8FAFC; padding: 15px; border-radius: 12px; border: 1px solid #E2E8F0; margin-bottom: 15px; position: relative; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .input-grid input { padding: 8px; border: 1px solid #CBD5E1; border-radius: 6px; width: 100%; font-size: 14px; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        #inspectionScreen { padding: 10px; overflow: hidden; }
        .camera-container { position: relative; flex: 1; background: #000; border-radius: 20px; overflow: hidden; margin: 10px 0; display: flex; align-items: center; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; width: 100%; height: 100%; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; width: 100%; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-add { background: #F1F5F9; color: var(--text); margin-bottom: 10px; border: 1px dashed #CBD5E1; }
        
        /* Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
        .violation-card { border: 2px solid var(--danger); border-radius: 15px; padding: 15px; margin-bottom: 15px; background: #FFF5F5; }
        .violation-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #FEE2E2; padding-bottom: 5px; }
    </style>
</head>
<body>

    <div id="setupScreen" class="screen active-screen">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="font-size: 24px;">ğŸ›¡ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬ÙˆÙ„Ø© Ø§Ù„ÙØ­Øµ</h2>
            <p style="color: #64748B;">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø© ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚</p>
        </div>

        <input type="number" id="crNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ" style="width: 100%; padding: 14px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px;">
        
        <div id="roomsContainer">
            </div>

        <button class="btn btn-add" onclick="addRoomUI()">â• Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© / Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</button>
        <div style="flex: 1;"></div>
        <button class="btn btn-primary" onclick="startFullInspection()">Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ</button>
    </div>

    <div id="inspectionScreen" class="screen">
        <div style="text-align: center; background: #F8FAFC; padding: 10px; border-radius: 10px;">
            <h3 id="ui-room-name" style="color: var(--primary); font-size: 18px;">Ø§Ù„Ù…Ø·Ø¨Ø®</h3>
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 5px; font-size: 14px;">
                <span id="ui-task-name" style="font-weight: bold;">ÙØ­Øµ Ø§Ù„Ø²ÙˆØ§ÙŠØ§</span>
                <span id="ui-counter" style="color: #64748B;">(1 Ù…Ù† 4)</span>
            </div>
        </div>

        <div class="camera-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="overlay"></canvas>
        </div>

        <button class="btn btn-primary" onclick="captureAndLogic()">ğŸ“¸ ØªØ­Ù„ÙŠÙ„ ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¹Ù†ØµØ±</button>
    </div>

    <div id="reportScreen" class="screen">
        <h2 style="color: var(--danger); text-align: center; margin-bottom: 5px;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h2>
        <p id="reportCRDisplay" style="text-align: center; color: #64748B; margin-bottom: 20px;"></p>
        
        <div id="violationList"></div>
        
        <div style="flex: 1;"></div>
        <button class="btn btn-primary" onclick="location.reload()">Ø¬ÙˆÙ„Ø© ÙØ­Øµ Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>

<script>
    let roomsData = [], currentRoomIdx = 0, currentTaskType = 'walls', taskCounter = 1, violations = [];
    const canvas = document.getElementById('overlay'), ctx = canvas.getContext('2d');

    // Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    function addRoomUI() {
        const id = Date.now();
        const html = `
            <div class="room-entry" id="room_${id}">
                <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ù…Ø·Ø¨Ø®)" class="r-name" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; font-weight:bold;">
                <div class="input-grid">
                    <div><label>Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†:</label><input type="number" class="r-walls" value="4"></div>
                    <div><label>Ø§Ù„Ø³Ù„Ø§Ù„:</label><input type="number" class="r-bins" value="2"></div>
                    <div><label>Ø§Ù„ØªÙ‡ÙˆÙŠØ©:</label><input type="number" class="r-vents" value="1"></div>
                    <div><label>Ø§Ù„Ø£Ø±Ø¶ÙŠØ©:</label><input type="number" class="r-floors" value="1"></div>
                </div>
            </div>`;
        document.getElementById('roomsContainer').insertAdjacentHTML('beforeend', html);
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    addRoomUI();

    async function startFullInspection() {
        const cr = document.getElementById('crNumber').value;
        if(!cr) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ");

        document.querySelectorAll('.room-entry').forEach(div => {
            roomsData.push({
                name: div.querySelector('.r-name').value || "ØºØ±ÙØ© ØºÙŠØ± Ù…Ø³Ù…Ù‰",
                walls: parseInt(div.querySelector('.r-walls').value) || 0,
                bins: parseInt(div.querySelector('.r-bins').value) || 0,
                vents: parseInt(div.querySelector('.r-vents').value) || 0,
                floors: parseInt(div.querySelector('.r-floors').value) || 0
            });
        });

        document.getElementById('setupScreen').classList.remove('active-screen');
        document.getElementById('inspectionScreen').classList.add('active-screen');
        
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('video').srcObject = stream;
        
        requestAnimationFrame(renderOverlays);
    }

    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ…Ø± (Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ©)
    function renderOverlays() {
        canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
        const cx = canvas.width/2, cy = canvas.height/2;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#0052CC'; ctx.lineWidth = 4;

        if (currentTaskType === 'walls') {
            // Ø±Ø³Ù… Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ Ù„Ù„Ø²ÙˆØ§ÙŠØ§
            ctx.setLineDash([8, 5]); ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, cy); ctx.lineTo(canvas.width, cy); ctx.stroke();
            ctx.setLineDash([]); ctx.lineWidth = 6;
            ctx.beginPath(); ctx.moveTo(cx, cy-100); ctx.arcTo(cx, cy, cx+100, cy, 100); ctx.stroke();
        } else if (currentTaskType === 'vents') {
            // Ø±Ø³Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªÙ‡ÙˆÙŠØ©
            ctx.strokeRect(cx-100, cy-60, 200, 120);
        } else if (currentTaskType === 'bins') {
            // Ø±Ø³Ù… Ø®Ø· Ø§Ù„Ø³Ù„Ø§Ù„
            ctx.beginPath(); ctx.moveTo(cx-120, cy+80); ctx.lineTo(cx+120, cy+80); ctx.stroke();
        } else if (currentTaskType === 'floors') {
            // Ø±Ø³Ù… Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©
            ctx.setLineDash([5, 5]); ctx.lineWidth = 1;
            for(let i=-3; i<=3; i++) {
                ctx.beginPath(); ctx.moveTo(cx+(i*60), 0); ctx.lineTo(cx+(i*60), canvas.height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, cy+(i*60)); ctx.lineTo(canvas.width, cy+(i*60)); ctx.stroke();
            }
        }
        
        updateInspectionUI();
        requestAnimationFrame(renderOverlays);
    }

    function updateInspectionUI() {
        const room = roomsData[currentRoomIdx];
        const labels = { walls: 'ÙØ­Øµ Ø§Ù„Ø²ÙˆØ§ÙŠØ§', bins: 'ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Ù„', vents: 'ÙØ­Øµ Ø§Ù„ØªÙ‡ÙˆÙŠØ©', floors: 'ÙØ­Øµ Ø§Ù„Ø£Ø±Ø¶ÙŠØ©' };
        document.getElementById('ui-room-name').innerText = room.name;
        document.getElementById('ui-task-name').innerText = labels[currentTaskType];
        document.getElementById('ui-counter').innerText = `(${taskCounter} Ù…Ù† ${room[currentTaskType]})`;
    }

    function captureAndLogic() {
        const isPass = Math.random() > 0.4; // Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
        const room = roomsData[currentRoomIdx];

        if (!isPass) {
            violations.push({
                room: room.name,
                item: document.getElementById('ui-task-name').innerText,
                count: taskCounter
            });
        }

        // ØªØ³Ù„Ø³Ù„ Ø§Ù„ÙØ­Øµ
        if (taskCounter < room[currentTaskType]) {
            taskCounter++;
        } else {
            const types = ['walls', 'bins', 'vents', 'floors'];
            let currentIdx = types.indexOf(currentTaskType);
            
            if (currentIdx < 3) {
                currentTaskType = types[currentIdx + 1];
                taskCounter = 1;
            } else if (currentRoomIdx < roomsData.length - 1) {
                currentRoomIdx++;
                currentTaskType = 'walls';
                taskCounter = 1;
                alert("Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØºØ±ÙØ© Ø§Ù„ØªØ§Ù„ÙŠØ©: " + roomsData[currentRoomIdx].name);
            } else {
                showFinalReport();
            }
        }
    }

    function showFinalReport() {
        document.getElementById('inspectionScreen').classList.remove('active-screen');
        document.getElementById('reportScreen').classList.add('active-screen');
        document.getElementById('reportCRDisplay').innerText = "Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ Ø±Ù‚Ù…: " + document.getElementById('crNumber').value;

        const list = document.getElementById('violationList');
        if (violations.length === 0) {
            list.innerHTML = "<div style='text-align:center; padding:40px;'>âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…ÙˆØ§ØµÙØ§Øª</div>";
        } else {
            list.innerHTML = violations.map(v => `
                <div class="violation-card">
                    <div class="violation-header">
                        <strong>ğŸ“ ${v.room}</strong>
                        <span style="color:var(--danger); font-weight:bold;">âš ï¸ Ù…Ø®Ø§Ù„Ù</span>
                    </div>
                    <div style="font-size:14px;">Ø§Ù„Ø¹Ù†ØµØ±: ${v.item} (Ø±Ù‚Ù… ${v.count})</div>
                    <div style="width:100%; height:120px; background:#ddd; border-radius:10px; margin-top:10px; display:flex; align-items:center; justify-content:center; color:#666; font-size:12px; border:1px solid #FEE2E2;">
                        [ØµÙˆØ±Ø© ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©]
                    </div>
                </div>
            `).join('');
        }
    }
</script>
</body>
</html>
