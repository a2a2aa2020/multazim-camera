<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ù…Ù„ØªØ²Ù… â€” ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙØ­Øµ</title>

  <style>
    :root{
      /* Gov-like design tokens (Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ø­Ø³Ø¨ Ù‡ÙˆÙŠØ© Ø§Ù„Ø¬Ù‡Ø©) */
      --bg: #050607;
      --surface: rgba(20, 24, 28, .72);
      --surface-2: rgba(255,255,255,.08);
      --text: #F5F7FA;
      --muted: rgba(245,247,250,.72);

      --primary: #0B5FFF;   /* Ø­ÙƒÙˆÙ…ÙŠ Ø£Ø²Ø±Ù‚ */
      --accent: #19C37D;    /* Ø£Ø®Ø¶Ø± Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… */
      --warning: #F59E0B;
      --danger: #EF4444;

      --radius-xl: 22px;
      --radius-lg: 16px;
      --radius-md: 12px;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --hairline: rgba(255,255,255,.12);

      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    *{ box-sizing: border-box; margin:0; padding:0; }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    /* Camera stage */
    .stage{
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #000;
    }

    #video{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: cover;
      transform: scaleX(1);
    }

    #captureCanvas{ display:none; }
    #overlay{
      position:absolute; inset:0;
      width:100%; height:100%;
      pointer-events:none;
    }

    /* Top bar */
    .topbar{
      position:absolute;
      top:0; left:0; right:0;
      padding: calc(14px + var(--safe-top)) 16px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      z-index: 10;
      background: linear-gradient(180deg, rgba(0,0,0,.75) 0%, rgba(0,0,0,0) 100%);
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }

    .logo{
      width: 34px; height:34px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(11,95,255,.95), rgba(25,195,125,.95));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
    }

    .titleWrap{ display:flex; flex-direction:column; min-width:0; }
    .title{
      font-size: 15px;
      font-weight: 800;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      font-size: 12px;
      color: var(--muted);
      margin-top: 3px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .topActions{ display:flex; align-items:center; gap:10px; }
    .iconBtn{
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor: pointer;
      display:flex; align-items:center; gap:8px;
      font-weight: 700;
      font-size: 13px;
    }
    .iconBtn:active{ transform: scale(.98); }

    /* Hint chip */
    .hint{
      position:absolute;
      top: calc(82px + var(--safe-top));
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--hairline);
      background: rgba(20,24,28,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: var(--text);
      font-size: 14px;
      box-shadow: 0 10px 35px rgba(0,0,0,.45);
      max-width: 92vw;
      text-align:center;
    }

    /* Level pill */
    .levelPill{
      position:absolute;
      top: calc(128px + var(--safe-top));
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--hairline);
      background: rgba(20,24,28,.62);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-weight: 900;
      font-size: 13px;
      display:flex;
      gap:10px;
      align-items:center;
      box-shadow: 0 10px 35px rgba(0,0,0,.45);
      max-width: 92vw;
      justify-content:center;
    }
    .levelDot{ width:10px;height:10px;border-radius:999px;background: var(--warning); }
    .levelVals{ color: var(--muted); font-weight:800; }

    /* Bottom sheet */
    .sheet{
      position:absolute;
      left:0; right:0; bottom:0;
      padding: 10px 14px calc(14px + var(--safe-bottom));
      z-index: 10;
      background: linear-gradient(0deg, rgba(0,0,0,.92) 0%, rgba(0,0,0,0) 100%);
    }

    .sheetCard{
      border: 1px solid var(--hairline);
      background: rgba(20,24,28,.56);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--radius-xl);
      padding: 12px;
      box-shadow: var(--shadow);
    }

    .types{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding: 6px 4px 10px;
      scrollbar-width: none;
    }
    .types::-webkit-scrollbar{ display:none; }

    .chip{
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 750;
      cursor:pointer;
      white-space: nowrap;
      transition: .18s ease;
      display:flex; align-items:center; gap:8px;
    }
    .chip.active{
      background: rgba(11,95,255,.22);
      border-color: rgba(11,95,255,.65);
      box-shadow: 0 12px 30px rgba(11,95,255,.14);
    }
    .chip:active{ transform: scale(.98); }

    .captureRow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 6px 4px 2px;
    }

    .miniBtn{
      width: 46px; height:46px;
      border-radius: 16px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size: 18px;
    }
    .miniBtn:active{ transform: scale(.98); }

    .capture{
      width: 78px; height:78px;
      border-radius: 999px;
      border: 3px solid rgba(255,255,255,.92);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,0)),
                  linear-gradient(135deg, rgba(11,95,255,.92), rgba(25,195,125,.92));
      box-shadow: 0 18px 45px rgba(0,0,0,.55);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size: 26px;
      transition: opacity .2s ease;
    }
    .capture.processing{ opacity:.65; pointer-events:none; filter: grayscale(.35); }
    .capture:active{ transform: scale(.98); }

    /* Permission screen */
    .perm{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding: 22px;
      background: radial-gradient(1000px 800px at 70% 20%, rgba(11,95,255,.22), transparent 55%),
                  radial-gradient(900px 700px at 20% 70%, rgba(25,195,125,.18), transparent 55%),
                  #070A0E;
      z-index: 100;
    }
    .permCard{
      width: min(420px, 92vw);
      border-radius: 26px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--hairline);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 22px;
      box-shadow: var(--shadow);
      text-align:center;
    }
    .permCard h2{ font-size: 18px; margin-top: 12px; }
    .permCard p{ color: var(--muted); margin-top: 10px; line-height:1.7; font-size: 14px; }
    .primaryBtn{
      margin-top: 16px;
      width: 100%;
      border: none;
      background: var(--primary);
      color: #fff;
      font-weight: 800;
      padding: 14px 16px;
      border-radius: 16px;
      cursor:pointer;
      box-shadow: 0 18px 35px rgba(11,95,255,.25);
      font-size: 15px;
    }
    .primaryBtn:active{ transform: scale(.99); }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.92);
      z-index: 200;
      display:none;
      padding: calc(14px + var(--safe-top)) 14px calc(14px + var(--safe-bottom));
    }
    .modal.active{ display:flex; flex-direction:column; gap:12px; }

    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      border-radius: 18px;
      border: 1px solid var(--hairline);
      background: rgba(20,24,28,.56);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .modalHeader strong{ font-size: 15px; }
    .closeBtn{
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 14px;
      cursor:pointer;
    }

    .modalBody{
      flex:1;
      overflow:auto;
      border-radius: 22px;
      border: 1px solid var(--hairline);
      background: rgba(20,24,28,.56);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 14px;
    }

    .preview{
      width:100%;
      border-radius: 18px;
      border: 1px solid var(--hairline);
      margin-bottom: 14px;
      display:block;
    }

    .card{
      border-radius: 18px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      padding: 14px;
    }

    .statusRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .badge{
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      border: 1px solid var(--hairline);
      display:inline-flex; align-items:center; gap:8px;
    }
    .badge.ok{ background: rgba(25,195,125,.14); border-color: rgba(25,195,125,.45); }
    .badge.no{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.45); }
    .badge.maybe{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.45); }

    .meta{ color: var(--muted); font-size: 13px; margin-top: 10px; }
    .bar{
      height: 10px; border-radius: 999px; background: rgba(255,255,255,.10);
      margin-top: 10px; overflow:hidden;
      border: 1px solid var(--hairline);
    }
    .fill{ height:100%; width:0%; transition: width 600ms ease; }

    .msg{
      margin-top: 12px;
      color: rgba(245,247,250,.9);
      line-height: 1.7;
      font-size: 14px;
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .ghost{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 800;
      cursor:pointer;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(110px + var(--safe-bottom));
      z-index: 300;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--hairline);
      background: rgba(20,24,28,.72);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: var(--text);
      font-size: 13px;
      display:none;
      max-width: 92vw;
      text-align:center;
      box-shadow: 0 16px 50px rgba(0,0,0,.55);
    }
    .toast.show{ display:block; }
  </style>

  <!-- EmailJS (Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¢Ù†) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>

<body>

  <!-- Permission -->
  <div id="perm" class="perm">
    <div class="permCard">
      <div style="font-size:64px">ğŸ“·</div>
      <h2 id="permTitle">Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª Ù…Ø·Ù„ÙˆØ¨</h2>
      <p id="permDesc">
        ØªØ³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ø¥Ø¬Ø±Ø§Ø¡ ÙØ­Øµ Ù…ÙŠØ¯Ø§Ù†ÙŠØŒ ÙˆØªØ³ØªØ®Ø¯Ù… Ø­Ø³Ø§Ø³Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² (Pitch/Roll) Ù„ØªØ«Ø¨ÙŠØª ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„Ù‡Ø§ØªÙ ÙˆØªØ­Ø³ÙŠÙ† Ø¯Ù‚Ø© Ø§Ù„ÙØ­Øµ.
      </p>
      <button class="primaryBtn" id="permBtn">Ø§Ù„Ø³Ù…Ø§Ø­ ÙˆØ§Ù„Ø¨Ø¯Ø¡</button>
      <p style="margin-top:12px; font-size:12px; color: var(--muted);">
        Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø§Ø´Ø©.
      </p>
    </div>
  </div>

  <!-- Stage -->
  <div class="stage" id="stage" style="display:none;">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="captureCanvas"></canvas>
    <canvas id="overlay"></canvas>

    <div class="topbar">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div class="titleWrap">
          <div class="title" id="appTitle">Ù…Ù„ØªØ²Ù… â€” ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙØ­Øµ</div>
          <div class="subtitle" id="appSub">Ø®Ø¯Ù…Ø© ÙØ­Øµ Ù…ÙŠØ¯Ø§Ù†ÙŠ â€” Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</div>
        </div>
      </div>

      <div class="topActions">
        <button class="iconBtn" id="langBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©">
          ğŸŒ <span id="langLabel">EN</span>
        </button>
      </div>
    </div>

    <div class="hint" id="hint">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ ÙØ­ØµÙ‡Ø§</div>

    <!-- Level indicator -->
    <div id="levelPill" class="levelPill">
      <span id="levelDot" class="levelDot"></span>
      <span id="levelText">Ø«Ø¨Ù‘Øª Ø§Ù„Ù‡Ø§ØªÙ Ù„ÙŠØµØ¨Ø­ Ù…Ø³ØªÙˆÙŠÙ‹Ø§ (Â±2Â°)</span>
      <span id="levelVals" class="levelVals"></span>
    </div>

    <div class="sheet">
      <div class="sheetCard">
        <div class="types" id="types">
          <button class="chip active" data-type="4.5">ğŸ“ Ø²ÙˆØ§ÙŠØ§ 45Â°</button>
          <button class="chip" data-type="4.7">ğŸŒ¬ï¸ Ø§Ù„ØªÙ‡ÙˆÙŠØ©</button>
          <button class="chip" data-type="5.8">ğŸ—‘ï¸ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª</button>
          <button class="chip" data-type="defects">ğŸ”§ Ø§Ù„Ø¹ÙŠÙˆØ¨</button>
        </div>

        <div class="captureRow">
          <button class="miniBtn" id="switchBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">ğŸ”„</button>
          <button class="capture" id="captureBtn" title="Ø§Ù„ØªÙ‚Ø§Ø·">ğŸ“·</button>
          <button class="miniBtn" id="stopBtn" title="Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">â»</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalHeader">
      <strong id="modalTitle">Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ</strong>
      <button class="closeBtn" id="modalClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
    </div>

    <div class="modalBody">
      <img id="preview" class="preview" alt="Captured" />
      <div class="card">
        <div class="statusRow">
          <div id="badge" class="badge maybe">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„</div>
          <div style="text-align:left">
            <div style="font-weight:900" id="ruleLabel">Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© 4.5</div>
            <div class="meta" id="confText">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©: â€”</div>
          </div>
        </div>

        <div class="bar"><div class="fill" id="fill"></div></div>
        <div class="msg" id="msg">ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©â€¦</div>

        <div class="actions">
          <button class="ghost" id="retryBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
          <button class="primaryBtn" id="newBtn" style="margin:0;">ÙØ­Øµ Ø¬Ø¯ÙŠØ¯</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // ===========================
  //  EmailJS Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¹Ø¯Ù‘Ù„Ù‡Ø§)
  // ===========================
  const EMAILJS_PUBLIC_KEY = "PUT_YOUR_PUBLIC_KEY_HERE";
  const EMAILJS_SERVICE_ID = "PUT_YOUR_SERVICE_ID_HERE";
  const EMAILJS_TEMPLATE_ID = "PUT_YOUR_TEMPLATE_ID_HERE";

  // Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø«Ø§Ø¨Øª Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ
  const EMAIL_TO = "a.alamm@datainsight.com.sa";

  // ØªÙ‡ÙŠØ¦Ø© EmailJS
  // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ¬Ø±Ø¨Ø©
  emailjs.init(EMAILJS_PUBLIC_KEY);

  // ===== State =====
  let stream = null;
  let currentLang = 'ar';
  let selectedType = '4.5';
  let facingMode = 'environment'; // or 'user'
  let lastBlob = null;

  // ===== Level / Sensors =====
  let lastPitch = null;
  let lastRoll = null;
  let isLevel = false;
  const LEVEL_TOL_DEG = 2; // Â±2Â°

  // ===== Translations =====
  const TT = {
    ar: {
      appTitle: 'Ù…Ù„ØªØ²Ù… â€” ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙØ­Øµ',
      appSub: 'Ø®Ø¯Ù…Ø© ÙØ­Øµ Ù…ÙŠØ¯Ø§Ù†ÙŠ â€” Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©',
      hint: 'ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ ÙØ­ØµÙ‡Ø§',
      modalTitle: 'Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ',
      retry: 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„',
      newScan: 'ÙØ­Øµ Ø¬Ø¯ÙŠØ¯',
      close: 'Ø¥ØºÙ„Ø§Ù‚ âœ•',
      lang: 'EN',
      rule: (x)=> x==='defects' ? 'ÙØ­Øµ Ø§Ù„Ø¹ÙŠÙˆØ¨' : `Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ${x}`,
      levelHold: (tol)=> `Ø«Ø¨Ù‘Øª Ø§Ù„Ù‡Ø§ØªÙ Ù„ÙŠØµØ¨Ø­ Ù…Ø³ØªÙˆÙŠÙ‹Ø§ (Â±${tol}Â°)`,
      levelOk: 'âœ… Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø³ØªÙˆÙ â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·',
      emailSent: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ âœ…',
      emailFail: 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ EmailJS.',
    },
    en: {
      appTitle: 'Multazim â€” Inspection Camera',
      appSub: 'Field inspection service â€” Beta',
      hint: 'Point the camera at the area to inspect',
      modalTitle: 'Inspection Result',
      retry: 'Retry',
      newScan: 'New Scan',
      close: 'Close âœ•',
      lang: 'AR',
      rule: (x)=> x==='defects' ? 'Defects Scan' : `Rule ${x}`,
      levelHold: (tol)=> `Hold device level (Â±${tol}Â°)`,
      levelOk: 'âœ… Level â€” You can capture',
      emailSent: 'Result emailed âœ…',
      emailFail: 'Email failed. Check EmailJS setup.',
    }
  };

  // ===== Helpers =====
  function toast(msg){
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(()=> el.classList.remove('show'), 2400);
  }

  function setTexts(){
    const L = TT[currentLang];
    document.documentElement.lang = currentLang;
    document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';

    document.getElementById('appTitle').textContent = L.appTitle;
    document.getElementById('appSub').textContent = L.appSub;
    document.getElementById('hint').textContent = L.hint;

    document.getElementById('modalTitle').textContent = L.modalTitle;
    document.getElementById('retryBtn').textContent = L.retry;
    document.getElementById('newBtn').textContent = L.newScan;
    document.getElementById('modalClose').textContent = L.close;
    document.getElementById('langLabel').textContent = L.lang;

    document.getElementById('ruleLabel').textContent = L.rule(selectedType);

    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const levelText = document.getElementById('levelText');
    levelText.textContent = isLevel ? L.levelOk : L.levelHold(LEVEL_TOL_DEG);
  }

  function disableCapture(){
    const captureBtn = document.getElementById('captureBtn');
    captureBtn.style.opacity = '.55';
    captureBtn.style.pointerEvents = 'none';
  }

  function enableCapture(){
    const captureBtn = document.getElementById('captureBtn');
    captureBtn.style.opacity = '1';
    captureBtn.style.pointerEvents = 'auto';
  }

  // ===== Sensors =====
  function updateLevelUI(pitch, roll){
    const dot = document.getElementById('levelDot');
    const text = document.getElementById('levelText');
    const vals = document.getElementById('levelVals');
    const L = TT[currentLang];

    const p = Math.round(pitch * 10) / 10;
    const r = Math.round(roll * 10) / 10;

    vals.textContent = `P:${p}Â°  R:${r}Â°`;

    isLevel = (Math.abs(pitch) <= LEVEL_TOL_DEG) && (Math.abs(roll) <= LEVEL_TOL_DEG);

    if(isLevel){
      dot.style.background = 'var(--accent)';
      text.textContent = L.levelOk;
      enableCapture();
    } else {
      dot.style.background = 'var(--warning)';
      text.textContent = L.levelHold(LEVEL_TOL_DEG);
      disableCapture();
    }
  }

  function handleOrientation(e){
    const pitch = (typeof e.beta === 'number') ? e.beta : 0;   // front-back
    const roll  = (typeof e.gamma === 'number') ? e.gamma : 0; // left-right
    lastPitch = pitch;
    lastRoll = roll;
    updateLevelUI(pitch, roll);
  }

  async function enableSensors(){
    try{
      if(typeof DeviceOrientationEvent !== 'undefined' &&
         typeof DeviceOrientationEvent.requestPermission === 'function'){
        const res = await DeviceOrientationEvent.requestPermission();
        if(res !== 'granted'){
          toast(currentLang==='ar' ? 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª.' : 'Sensor permission denied.');
          disableCapture(); // Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø³Ø§Øª Ù†Ø®Ù„ÙŠ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ù…Ù‚ÙÙˆÙ„
          return false;
        }
      }
      window.addEventListener('deviceorientation', handleOrientation, true);
      return true;
    }catch(err){
      console.error(err);
      toast(currentLang==='ar' ? 'ØªØ¹Ø°Ù‘Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª.' : 'Failed to enable sensors.');
      disableCapture();
      return false;
    }
  }

  function removeSensors(){
    window.removeEventListener('deviceorientation', handleOrientation, true);
    lastPitch = null;
    lastRoll = null;
    isLevel = false;
  }

  // ===== Camera =====
  async function startCamera(){
    stopCamera(); // ensure no double streams
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode, width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });

      const video = document.getElementById('video');
      video.srcObject = stream;

      document.getElementById('perm').style.display = 'none';
      document.getElementById('stage').style.display = 'block';

      await video.play();

      // Overlay loop
      resizeOverlay();
      drawLoop();

      // Sensors (Ø¨Ø¹Ø¯ Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø³Ù…Ø§Ø­ â€” Ù…Ù†Ø§Ø³Ø¨ Ù„Ù€ iOS)
      disableCapture();          // Ù†Ù‚ÙÙ„ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
      await enableSensors();     // Ø³ÙŠÙØªØ­ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙˆØ§Ø¡

    }catch(e){
      toast(currentLang==='ar'
        ? 'ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†.'
        : 'Unable to start camera. Please grant permission.'
      );
      console.error(e);
    }
  }

  function stopCamera(){
    if(stream){
      stream.getTracks().forEach(tr=> tr.stop());
      stream = null;
    }
  }

  // ===== Overlay drawing =====
  function resizeOverlay(){
    const overlay = document.getElementById('overlay');
    const rect = overlay.getBoundingClientRect();
    overlay.width = Math.floor(rect.width * devicePixelRatio);
    overlay.height = Math.floor(rect.height * devicePixelRatio);
  }

  function drawGuide(ctx, type){
    const w = ctx.canvas.width;
    const h = ctx.canvas.height;
    const cx = w/2, cy = h/2;

    ctx.clearRect(0,0,w,h);

    ctx.strokeStyle = 'rgba(11,95,255,.95)';
    ctx.lineWidth = 4;
    ctx.shadowColor = 'rgba(0,0,0,.55)';
    ctx.shadowBlur = 8;

    if(type === '4.5'){
      const size = Math.min(w,h)*0.38;
      ctx.beginPath();
      ctx.moveTo(cx - size/2, cy);
      ctx.lineTo(cx + size/2, cy);
      ctx.moveTo(cx, cy - size/2);
      ctx.lineTo(cx, cy + size/2);
      ctx.moveTo(cx - size/3, cy - size/3);
      ctx.lineTo(cx + size/3, cy + size/3);
      ctx.stroke();

      ctx.shadowBlur = 0;
      ctx.fillStyle = 'rgba(245,247,250,.92)';
      ctx.font = '900 28px system-ui, Arial';
      ctx.textAlign = 'center';
      ctx.fillText('45Â°', cx, cy - size/2 - 18);
    } else if(type === '4.7'){
      const rw = w*0.62;
      const rh = h*0.36;
      ctx.strokeRect(cx - rw/2, cy - rh/2, rw, rh);
    } else if(type === '5.8'){
      const r = Math.min(w,h)*0.26;
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.stroke();
    } else {
      ctx.strokeStyle = 'rgba(11,95,255,.25)';
      ctx.lineWidth = 2;
      for(let i=1;i<4;i++){
        ctx.beginPath();
        ctx.moveTo(w*i/4, 0);
        ctx.lineTo(w*i/4, h);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, h*i/4);
        ctx.lineTo(w, h*i/4);
        ctx.stroke();
      }
    }
  }

  let rafId = null;
  function drawLoop(){
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const loop = ()=>{
      drawGuide(ctx, selectedType);
      rafId = requestAnimationFrame(loop);
    };
    loop();
  }

  function stopOverlayLoop(){
    if(rafId) cancelAnimationFrame(rafId);
    rafId = null;
  }

  function setType(type){
    selectedType = type;
    document.querySelectorAll('.chip').forEach(b=>{
      b.classList.toggle('active', b.dataset.type===type);
    });
    setTexts();
  }

  // ===== Capture & Analyze (Ù…Ø­Ø§ÙƒØ§Ø©) =====
  async function capture(){
    // Ù‚ÙÙ„ Ù†Ù‡Ø§Ø¦ÙŠ: Ø­ØªÙ‰ Ù„Ùˆ UI Ù…ÙØªÙˆØ­ Ø¨Ø§Ù„Ø®Ø·Ø£
    if(!isLevel){
      toast(currentLang==='ar' ? 'Ø«Ø¨Ù‘Øª Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙˆÙ„Ø§Ù‹ Ø­ØªÙ‰ ÙŠØµØ¨Ø­ Ù…Ø³ØªÙˆÙŠÙ‹Ø§.' : 'Hold device level first.');
      return;
    }

    const btn = document.getElementById('captureBtn');
    btn.classList.add('processing');

    try{
      const video = document.getElementById('video');
      const canvas = document.getElementById('captureCanvas');
      const ctx = canvas.getContext('2d');

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      lastBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.86));
      const url = URL.createObjectURL(lastBlob);
      document.getElementById('preview').src = url;

      openModalLoading();
      setTimeout(async ()=>{
        const result = mockResult();
        showResult(result);

        // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø¹Ø¯ ÙƒÙ„ ÙØ­Øµ
        try{
          await sendResultEmail(result);
          toast(TT[currentLang].emailSent);
        }catch(err){
          console.error(err);
          toast(TT[currentLang].emailFail);
        }
      }, 900);

    }catch(e){
      toast(currentLang==='ar' ? 'ÙØ´Ù„ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©.' : 'Capture failed.');
      console.error(e);
    }finally{
      btn.classList.remove('processing');
    }
  }

  function openModalLoading(){
    const L = TT[currentLang];
    document.getElementById('modal').classList.add('active');
    document.getElementById('badge').className = 'badge maybe';
    document.getElementById('badge').textContent = currentLang==='ar' ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„' : 'â³ Analyzing';
    document.getElementById('confText').textContent = currentLang==='ar' ? 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©: â€”' : 'Confidence: â€”';
    document.getElementById('fill').style.width = '0%';
    document.getElementById('fill').style.background = 'linear-gradient(90deg, rgba(245,158,11,.9), rgba(11,95,255,.9))';
    document.getElementById('msg').textContent = currentLang==='ar'
      ? 'ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©â€¦'
      : 'Processing the imageâ€¦';
    document.getElementById('ruleLabel').textContent = L.rule(selectedType);
  }

  function closeModal(){
    document.getElementById('modal').classList.remove('active');
    const img = document.getElementById('preview');
    if(img.src.startsWith('blob:')) URL.revokeObjectURL(img.src);
    img.src = '';
  }

  function mockResult(){
    const pick = Math.random();
    if(pick < 0.45){
      return { status:'compliant', confidence: 92 + Math.floor(Math.random()*6),
        msgAr:'ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…ÙˆØ§ØµÙØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© â€” Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…Ø¹Ø§ÙŠÙŠØ±.',
        msgEn:'Required specification detected â€” compliant.' };
    } else if(pick < 0.8){
      return { status:'non-compliant', confidence: 78 + Math.floor(Math.random()*10),
        msgAr:'ØªÙ… Ø±ØµØ¯ Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© â€” ÙŠÙ„Ø²Ù… Ø¥Ø¬Ø±Ø§Ø¡ ØªØµØ­ÙŠØ­ÙŠ.',
        msgEn:'Non-compliance detected â€” corrective action required.' };
    }
    return { status:'uncertain', confidence: 55 + Math.floor(Math.random()*18),
      msgAr:'ØºÙŠØ± Ù‚Ø§Ø¯Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨ÙˆØ¶ÙˆØ­ â€” ÙŠÙÙ†ØµØ­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ù…Ø¹ Ø¥Ø¶Ø§Ø¡Ø© Ø£ÙØ¶Ù„.',
      msgEn:'Unable to determine â€” retake with better lighting.' };
  }

  function showResult(r){
    const fill = document.getElementById('fill');
    const badge = document.getElementById('badge');
    const confText = document.getElementById('confText');
    const msg = document.getElementById('msg');

    const map = {
      compliant: { cls:'ok', color:'linear-gradient(90deg, rgba(25,195,125,.95), rgba(11,95,255,.65))',
        labelAr:'âœ“ Ù…Ø·Ø§Ø¨Ù‚', labelEn:'âœ“ Compliant' },
      'non-compliant': { cls:'no', color:'linear-gradient(90deg, rgba(239,68,68,.95), rgba(245,158,11,.55))',
        labelAr:'âœ• ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚', labelEn:'âœ• Non-Compliant' },
      uncertain: { cls:'maybe', color:'linear-gradient(90deg, rgba(245,158,11,.95), rgba(11,95,255,.55))',
        labelAr:'ØŸ ØºÙŠØ± Ù…Ø¤ÙƒØ¯', labelEn:'ï¼Ÿ Uncertain' }
    };

    const m = map[r.status];
    badge.className = 'badge ' + m.cls;
    badge.textContent = (currentLang==='ar') ? m.labelAr : m.labelEn;

    confText.textContent = (currentLang==='ar')
      ? `Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©: ${r.confidence}%`
      : `Confidence: ${r.confidence}%`;

    fill.style.background = m.color;
    requestAnimationFrame(()=> { fill.style.width = r.confidence + '%'; });

    msg.textContent = (currentLang==='ar') ? r.msgAr : r.msgEn;
  }

  // ===== EmailJS: Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ =====
  async function sendResultEmail(result){
    // Ø­Ù…Ø§ÙŠØ©: Ø¥Ø°Ø§ Ù„Ù… ØªÙØ¹Ø¯Ù‘Ù„ Ù…ÙØ§ØªÙŠØ­ EmailJSØŒ Ù„Ø§ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    if(!EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY.includes("PUT_") ||
       !EMAILJS_SERVICE_ID || EMAILJS_SERVICE_ID.includes("PUT_") ||
       !EMAILJS_TEMPLATE_ID || EMAILJS_TEMPLATE_ID.includes("PUT_")){
      throw new Error("EmailJS keys not set");
    }

    const L = TT[currentLang];
    const ts = new Date();
    const payload = {
      to_email: EMAIL_TO,
      rule: L.rule(selectedType),
      rule_code: selectedType,
      status: result.status,
      confidence: result.confidence + '%',
      message: (currentLang==='ar') ? result.msgAr : result.msgEn,
      pitch: (typeof lastPitch === 'number') ? lastPitch.toFixed(2) + 'Â°' : 'N/A',
      roll: (typeof lastRoll === 'number') ? lastRoll.toFixed(2) + 'Â°' : 'N/A',
      timestamp: ts.toLocaleString(),
      lang: currentLang.toUpperCase()
    };

    // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± EmailJS Template Variables
    return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, payload);
  }

  // ===== Events =====
  document.getElementById('permBtn').addEventListener('click', startCamera);

  document.getElementById('langBtn').addEventListener('click', ()=>{
    currentLang = (currentLang==='ar') ? 'en' : 'ar';
    setTexts();
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
    if(typeof lastPitch === 'number' && typeof lastRoll === 'number'){
      updateLevelUI(lastPitch, lastRoll);
    }
  });

  document.getElementById('types').addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip');
    if(!btn) return;
    setType(btn.dataset.type);
  });

  document.getElementById('captureBtn').addEventListener('click', capture);

  document.getElementById('retryBtn').addEventListener('click', ()=>{
    openModalLoading();
    setTimeout(async ()=>{
      const result = mockResult();
      showResult(result);
      try{
        await sendResultEmail(result);
        toast(TT[currentLang].emailSent);
      }catch(err){
        console.error(err);
        toast(TT[currentLang].emailFail);
      }
    }, 800);
  });

  document.getElementById('newBtn').addEventListener('click', closeModal);
  document.getElementById('modalClose').addEventListener('click', closeModal);

  document.getElementById('stopBtn').addEventListener('click', ()=>{
    stopOverlayLoop();
    stopCamera();
    removeSensors();
    document.getElementById('stage').style.display = 'none';
    document.getElementById('perm').style.display = 'flex';
    disableCapture();
    toast(currentLang==='ar' ? 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.' : 'Camera stopped.');
  });

  document.getElementById('switchBtn').addEventListener('click', async ()=>{
    facingMode = (facingMode === 'environment') ? 'user' : 'environment';
    toast(currentLang==='ar'
      ? (facingMode==='environment' ? 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©' : 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©')
      : (facingMode==='environment' ? 'Rear camera' : 'Front camera')
    );
    removeSensors();
    await startCamera();
  });

  window.addEventListener('resize', resizeOverlay);

  // init
  disableCapture();
  setTexts();
</script>

</body>
</html>
