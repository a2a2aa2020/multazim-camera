<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ù†Ø¸Ø§Ù… Ù…Ù„ØªØ²Ù… Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø°Ø§ØªÙŠ</title>
    <style>
        :root { 
            --primary: #0052CC; --success: #27AE60; --danger: #E74C3C; --warning: #F1C40F;
            --bg: #F8FAFC; --text: #1E293B; --border: #E2E8F0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; position: absolute; inset: 0; background: white; z-index: 10; }
        .active-screen { display: flex; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginScreen { align-items: center; justify-content: center; padding: 30px; }
        .login-card { width: 100%; max-width: 400px; text-align: center; }
        input[type="number"] { width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 12px; font-size: 18px; margin: 20px 0; outline: none; transition: border-color 0.3s; }
        input:focus { border-color: var(--primary); }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„ÙØ­Øµ */
        .camera-header { background: white; padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; z-index: 20; }
        .camera-container { flex: 1; position: relative; background: #000; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #overlay { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .camera-footer { background: white; padding: 20px; border-top: 1px solid var(--border); }
        .controls-row { display: flex; gap: 10px; margin-bottom: 15px; }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 15px; transition: opacity 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-secondary { background: #F1F5F9; color: var(--text); flex: 1; }
        .btn-finish { background: var(--success); color: white; width: 100%; margin-top: 10px; }

        /* Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ */
        #reportScreen { overflow-y: auto; padding: 25px; background: #fff; }
        .heatmap-container { width: 100%; height: 250px; background: #f1f5f9; border-radius: 15px; margin: 20px 0; position: relative; border: 1px solid var(--border); }
        .report-item { padding: 15px; border-radius: 10px; margin-bottom: 10px; border-right: 5px solid #ccc; background: #f8fafc; }
        .report-fail { border-right-color: var(--danger); background: #FEF2F2; }
        .report-pass { border-right-color: var(--success); background: #F0FDF4; }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen active-screen">
        <div class="login-card">
            <div style="font-size: 50px; margin-bottom: 10px;">ğŸ›¡ï¸</div>
            <h2>Ù†Ø¸Ø§Ù… Ù…Ù„ØªØ²Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠ</h2>
            <p style="color: #64748B;">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø°Ø§ØªÙŠ Ù„Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©</p>
            <input type="number" id="crNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ">
            <button class="btn btn-primary" onclick="goToInspection()">Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø§Ù„ÙØ­Øµ</button>
        </div>
    </div>

    <div id="inspectionScreen" class="screen">
        <div class="camera-header">
            <select id="currentRoom" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <option value="Ø§Ù„Ù…Ø·Ø¨Ø®">Ø§Ù„Ù…Ø·Ø¨Ø® Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
                <option value="Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</option>
                <option value="Ø§Ù„ØµØ§Ù„Ø©">ØµØ§Ù„Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</option>
                <option value="Ø§Ù„ØªØ­Ø¶ÙŠØ±">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±</option>
            </select>
            <select id="checkType" onchange="drawOverlay()" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <option value="4.5">ğŸ“ Ø§Ù„Ø²ÙˆØ§ÙŠØ§</option>
                <option value="4.7">ğŸŒ¬ï¸ Ø§Ù„ØªÙ‡ÙˆÙŠØ© (Ø´Ø¨Ùƒ)</option>
                <option value="5.8">ğŸ—‘ï¸ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª (ØºØ·Ø§Ø¡)</option>
                <option value="floor">ğŸ§± Ø§Ù„Ø£Ø±Ø¶ÙŠØ§Øª</option>
            </select>
        </div>

        <div class="camera-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="overlay"></canvas>
        </div>

        <div class="camera-footer">
            <div id="instruction" style="text-align:center; font-size:13px; color:#64748B; margin-bottom:15px;">
                Ø­Ø§Ø°Ù Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ Ù…Ø¹ Ø­ÙˆØ§Ù Ø§Ù„Ø¬Ø¯Ø§Ø±
            </div>
            <div class="controls-row">
                <button class="btn btn-secondary" onclick="flipX *= -1">ğŸ”„ Ø¹ÙƒØ³ Ø§Ù„Ø§ØªØ¬Ø§Ù‡</button>
                <button class="btn btn-primary" style="flex: 2;" onclick="analyzeCurrentTask()">ğŸ“¸ ØªØ­Ù„ÙŠÙ„ ÙˆØªÙˆØ«ÙŠÙ‚</button>
            </div>
            <button class="btn btn-finish" onclick="generateReport()">Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
        </div>
    </div>

    <div id="reportScreen" class="screen">
        <h2 style="text-align: center;">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2>
        <p id="reportMeta" style="text-align: center; color: #64748B; font-size: 14px; margin-top: 5px;"></p>
        
        <h4 style="margin-top: 25px;">ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© Ù„Ù„Ù…Ù†Ø´Ø£Ø©:</h4>
        <canvas id="heatMapCanvas" class="heatmap-container"></canvas>

        <h4>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø­ÙƒÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚):</h4>
        <div id="resultsList" style="margin-top: 15px;"></div>

        <button class="btn btn-primary" style="margin: 30px 0;" onclick="location.reload()">ÙØ­Øµ Ù…Ù†Ø´Ø£Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>

<script>
    let stream, flipX = 1, inspectionLog = [];
    const roomsInfo = { "Ø§Ù„Ù…Ø·Ø¨Ø®": {x:20, y:20}, "Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹": {x:180, y:20}, "Ø§Ù„ØµØ§Ù„Ø©": {x:20, y:130}, "Ø§Ù„ØªØ­Ø¶ÙŠØ±": {x:180, y:130} };

    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ÙØ­Øµ
    async function goToInspection() {
        if(!document.getElementById('crNumber').value) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„");
        document.querySelector('.active-screen').classList.remove('active-screen');
        document.getElementById('inspectionScreen').classList.add('active-screen');
        
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('video').srcObject = stream;
        drawOverlay();
    }

    // Ø±Ø³Ù… Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ©
    function drawOverlay() {
        const c = document.getElementById('overlay'), ctx = c.getContext('2d');
        c.width = c.clientWidth; c.height = c.clientHeight;
        const cx = c.width/2, cy = c.height/2, type = document.getElementById('checkType').value;
        
        ctx.clearRect(0, 0, c.width, c.height);
        ctx.strokeStyle = '#0052CC'; ctx.lineWidth = 4;

        ctx.save();
        ctx.translate(cx, cy);
        ctx.scale(flipX, 1);

        if(type === '4.5') {
            // Ø®Ø·ÙˆØ· Ù…Ù…ØªØ¯Ø© Ù„Ù„Ø­ÙˆØ§Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            ctx.setLineDash([8, 5]); ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(0, -cy); ctx.lineTo(0, 0); ctx.lineTo(cx, 0); ctx.stroke();
            // Ù‚ÙˆØ³ Ø§Ù„Ø­ÙƒÙ…
            ctx.setLineDash([]); ctx.lineWidth = 6;
            ctx.beginPath(); ctx.moveTo(0, -100); ctx.arcTo(0, 0, 100, 0, 100); ctx.stroke();
            // Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙØ±Ø§Øº (Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø£Ø­Ù…Ø± Ø§Ù„Ù…ÙØªØ±Ø¶)
            ctx.fillStyle = "rgba(231, 76, 60, 0.2)";
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,-100); ctx.arcTo(0,0,100,0,100); ctx.fill();
        } else if(type === '4.7') {
            ctx.strokeRect(-100, -60, 200, 120); // Ø¥Ø·Ø§Ø± Ø§Ù„Ø´Ø¨Ùƒ
        } else if(type === '5.8') {
            ctx.beginPath(); ctx.moveTo(-120, 0); ctx.lineTo(120, 0); ctx.stroke(); // Ø®Ø· Ø§Ù„ØºØ·Ø§Ø¡
        } else if(type === 'floor') {
            ctx.setLineDash([5,5]); ctx.lineWidth = 1;
            for(let i=-2; i<=2; i++) { ctx.beginPath(); ctx.moveTo(i*50, -cy); ctx.lineTo(i*50, cy); ctx.stroke(); }
        }

        ctx.restore();
        requestAnimationFrame(drawOverlay);
    }

    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø¢Ù„ÙŠ (Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ù‡ÙˆØ§ØªÙ)
    function analyzeCurrentTask() {
        const type = document.getElementById('checkType').value;
        const room = document.getElementById('currentRoom').value;
        
        // Ù‡Ù†Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ­ÙƒÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø£Ø­Ù…Ø±)
        let isPass = Math.random() > 0.4; // Ù…Ø­Ø§ÙƒØ§Ø©: Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠÙƒØªØ´Ù Ø§Ù„Ø¹ÙŠÙˆØ¨ Ø¨Ù†Ø³Ø¨Ø© 40%
        let note = "Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…Ø¹Ø§ÙŠÙŠØ±";

        if(!isPass) {
            if(type === '4.5') note = "Ù…Ø®Ø§Ù„ÙØ©: Ø±ØµØ¯ Ø²Ø§ÙˆÙŠØ© Ù‚Ø§Ø¦Ù…Ø© (90 Ø¯Ø±Ø¬Ø©) Ø®Ù„Ù Ø§Ù„Ù‚ÙˆØ³.";
            if(type === '4.7') note = "Ù…Ø®Ø§Ù„ÙØ©: ÙØªØ­Ø© Ø§Ù„ØªÙ‡ÙˆÙŠØ© ØªÙØªÙ‚Ø± Ù„Ø´Ø¨Ùƒ Ø§Ù„Ø­Ù…Ø§ÙŠØ©.";
            if(type === '5.8') note = "Ù…Ø®Ø§Ù„ÙØ©: Ø³Ù„Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª Ø¨Ø¯ÙˆÙ† ØºØ·Ø§Ø¡ Ù…Ø­ÙƒÙ….";
            if(type === 'floor') note = "Ù…Ø®Ø§Ù„ÙØ©: Ø±ØµØ¯ ØªØ´Ù‚Ù‚Ø§Øª/ØªØ¬Ù…Ø¹ Ù…ÙŠØ§Ù‡ ÙÙŠ Ø§Ù„Ø£Ø±Ø¶ÙŠØ©.";
        }

        inspectionLog.push({ room, type, isPass, note });
        alert(`ØªÙ… ØªØ­Ù„ÙŠÙ„ ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¨Ù†Ø¯ ÙÙŠ ${room}. Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.`);
    }

    // Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©
    function generateReport() {
        if(inspectionLog.length === 0) return alert("ÙŠØ±Ø¬Ù‰ ÙØ­Øµ Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
        
        document.querySelector('.active-screen').classList.remove('active-screen');
        document.getElementById('reportScreen').classList.add('active-screen');
        document.getElementById('reportMeta').innerText = `Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ: ${document.getElementById('crNumber').value} | Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}`;

        // 1. Ø±Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
        const canvas = document.getElementById('heatMapCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
        
        Object.keys(roomsInfo).forEach(roomName => {
            const pos = roomsInfo[roomName];
            const roomResults = inspectionLog.filter(l => l.room === roomName);
            
            let color = "#E2E8F0"; // Ø±Ù…Ø§Ø¯ÙŠ Ù„Ùˆ Ù„Ù… ØªÙØ­Øµ
            if(roomResults.length > 0) {
                color = roomResults.every(r => r.isPass) ? "#DCFCE7" : "#FEE2E2";
            }

            ctx.fillStyle = color;
            ctx.fillRect(pos.x, pos.y, 140, 90);
            ctx.strokeStyle = "#94A3B8"; ctx.strokeRect(pos.x, pos.y, 140, 90);
            ctx.fillStyle = "#1E293B"; ctx.font = "bold 14px sans-serif";
            ctx.fillText(roomName, pos.x + 10, pos.y + 25);
            
            if(roomResults.length > 0) {
                ctx.font = "20px sans-serif";
                ctx.fillText(roomResults.every(r => r.isPass) ? "âœ…" : "âŒ", pos.x + 100, pos.y + 75);
            }
        });

        // 2. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
        const list = document.getElementById('resultsList');
        list.innerHTML = inspectionLog.map(item => `
            <div class="report-item ${item.isPass ? 'report-pass' : 'report-fail'}">
                <strong>${item.room} - ${getTypeName(item.type)}</strong><br>
                <small>${item.note}</small>
            </div>
        `).join('');
    }

    function getTypeName(t) {
        return {'4.5':'Ø§Ù„Ø²ÙˆØ§ÙŠØ§', '4.7':'Ø§Ù„ØªÙ‡ÙˆÙŠØ©', '5.8':'Ø§Ù„Ù†ÙØ§ÙŠØ§Øª', 'floor':'Ø§Ù„Ø£Ø±Ø¶ÙŠØ§Øª'}[t];
    }
</script>
</body>
</html>
