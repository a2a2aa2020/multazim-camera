<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ù†Ø¸Ø§Ù… Ù…Ù„ØªØ²Ù… - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
    <style>
        :root { 
            --primary: #27AE60; /* ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø£Ø®Ø¶Ø± */
            --success: #27AE60; --danger: #E74C3C; 
            --bg: #FFFFFF; --safe-top: env(safe-area-inset-top); 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
        body { background: white; color: #1E293B; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; padding: 20px; padding-top: calc(var(--safe-top) + 20px); background: white; overflow-y: auto; }
        .active-screen { display: flex; }

        /* Ø´Ø¹Ø§Ø± Ø£Ø®Ø¶Ø± */
        .brand-green { color: var(--success); font-size: 60px; margin-bottom: 10px; }
        
        .room-entry { background: #F8FAFC; padding: 15px; border-radius: 12px; border: 1px solid #E2E8F0; margin-bottom: 15px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .input-grid input { padding: 8px; border: 1px solid #CBD5E1; border-radius: 6px; width: 100%; }
        
        #inspectionScreen { padding: 10px; overflow: hidden; }
        .camera-container { position: relative; flex: 1; background: #000; border-radius: 20px; overflow: hidden; margin: 10px 0; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; width: 100%; height: 100%; }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù‚ÙˆØ³ */
        .arc-controls { position: absolute; bottom: 10px; right: 10px; left: 10px; z-index: 20; display: none; gap: 10px; align-items: center; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 12px; }

        .btn { padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-add { background: #F1F5F9; color: #1E293B; margin-bottom: 10px; border: 1px dashed #CBD5E1; }
        
        .violation-card { border: 2px solid var(--danger); border-radius: 15px; padding: 15px; margin-bottom: 15px; background: #FFF5F5; }
    </style>
</head>
<body>

    <div id="setupScreen" class="screen active-screen">
        <div style="text-align: center; margin-bottom: 20px;">
            <div class="brand-green">ğŸ›¡ï¸</div>
            <h2 style="color: var(--success);">Ù†Ø¸Ø§Ù… Ù…Ù„ØªØ²Ù… Ø§Ù„Ø°ÙƒÙŠ</h2>
            <p style="color: #64748B;">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠ Ù„Ù„Ù…Ù†Ø´Ø¢Øª</p>
        </div>

        <input type="number" id="crNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ" style="width: 100%; padding: 14px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px;">
        <div id="roomsContainer"></div>
        <button class="btn btn-add" onclick="addRoomUI()">â• Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© / Ù‚Ø³Ù…</button>
        <div style="flex: 1;"></div>
        <button class="btn btn-primary" onclick="startFullInspection()">Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ</button>
    </div>

    <div id="inspectionScreen" class="screen">
        <div style="text-align: center; background: #F8FAFC; padding: 10px; border-radius: 10px;">
            <h3 id="ui-room-name" style="color: var(--success);">Ø§Ù„Ù…Ø·Ø¨Ø®</h3>
            <span id="ui-task-name" style="font-weight: bold;">ÙØ­Øµ Ø§Ù„Ø²ÙˆØ§ÙŠØ§</span>
            <span id="ui-counter" style="color: #64748B;">(1 Ù…Ù† 4)</span>
        </div>

        <div class="camera-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="overlay"></canvas>
            
            <div id="arcTools" class="arc-controls">
                <button onclick="flipX *= -1" style="padding: 8px; background: #fff; border: 1px solid #ccc; border-radius: 8px;">ğŸ”„ Ø¹ÙƒØ³</button>
                <input type="range" id="arcSize" min="50" max="150" value="100" style="flex: 1;">
                <span style="font-size: 12px;">Ø§Ù„Ø­Ø¬Ù…</span>
            </div>
        </div>

        <button class="btn btn-primary" onclick="captureAndLogic()">ğŸ“¸ ØªØ­Ù„ÙŠÙ„ ÙˆØªÙˆØ«ÙŠÙ‚</button>
    </div>

    <div id="reportScreen" class="screen">
        <h2 style="color: var(--danger); text-align: center;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h2>
        <div id="violationList" style="margin: 20px 0;"></div>
        <button class="btn btn-primary" onclick="location.reload()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

<script>
    let roomsData = [], currentRoomIdx = 0, currentTaskType = 'walls', taskCounter = 1, violations = [];
    let flipX = 1;
    const canvas = document.getElementById('overlay'), ctx = canvas.getContext('2d');

    function addRoomUI() {
        const id = Date.now();
        const html = `
            <div class="room-entry" id="room_${id}">
                <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©" class="r-name" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd; font-weight:bold;">
                <div class="input-grid">
                    <div><label>Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†:</label><input type="number" class="r-walls" value="4"></div>
                    <div><label>Ø§Ù„Ø³Ù„Ø§Ù„:</label><input type="number" class="r-bins" value="2"></div>
                    <div><label>Ø§Ù„ØªÙ‡ÙˆÙŠØ©:</label><input type="number" class="r-vents" value="1"></div>
                    <div><label>Ø§Ù„Ø£Ø±Ø¶ÙŠØ©:</label><input type="number" class="r-floors" value="1"></div>
                </div>
            </div>`;
        document.getElementById('roomsContainer').insertAdjacentHTML('beforeend', html);
    }
    addRoomUI();

    async function startFullInspection() {
        if(!document.getElementById('crNumber').value) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„");
        document.querySelectorAll('.room-entry').forEach(div => {
            roomsData.push({
                name: div.querySelector('.r-name').value || "ØºØ±ÙØ©",
                walls: parseInt(div.querySelector('.r-walls').value) || 0,
                bins: parseInt(div.querySelector('.r-bins').value) || 0,
                vents: parseInt(div.querySelector('.r-vents').value) || 0,
                floors: parseInt(div.querySelector('.r-floors').value) || 0
            });
        });
        document.getElementById('setupScreen').classList.remove('active-screen');
        document.getElementById('inspectionScreen').classList.add('active-screen');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('video').srcObject = stream;
        requestAnimationFrame(renderOverlays);
    }

    function renderOverlays() {
        canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
        const cx = canvas.width/2, cy = canvas.height/2;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‚ÙˆØ³ ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙØ­Øµ Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†
        document.getElementById('arcTools').style.display = (currentTaskType === 'walls') ? 'flex' : 'none';

        if (currentTaskType === 'walls') {
            const size = parseInt(document.getElementById('arcSize').value);
            ctx.save();
            ctx.translate(cx, cy);
            ctx.scale(flipX, 1);

            // 1. Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¸Ù„Ù„Ø© (Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØºØ·ÙŠÙ‡Ø§ Ø§Ù„Ø§Ù†Ø­Ù†Ø§Ø¡)
            ctx.fillStyle = "rgba(231, 76, 60, 0.2)";
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, -size); ctx.arcTo(0, 0, size, 0, size); ctx.closePath(); ctx.fill();

            // 2. Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ
            ctx.strokeStyle = '#27AE60'; ctx.lineWidth = 5;
            ctx.beginPath(); ctx.moveTo(0, -size); ctx.arcTo(0, 0, size, 0, size); ctx.stroke();

            // 3. Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©
            ctx.setLineDash([5, 5]); ctx.lineWidth = 1; ctx.strokeStyle = "#fff";
            ctx.beginPath(); ctx.moveTo(0, -cy); ctx.lineTo(0, 0); ctx.lineTo(cx, 0); ctx.stroke();
            ctx.restore();
        } else if (currentTaskType === 'vents') {
            ctx.strokeStyle = '#27AE60'; ctx.lineWidth = 4; ctx.strokeRect(cx-100, cy-60, 200, 120);
        } else if (currentTaskType === 'bins') {
            ctx.strokeStyle = '#27AE60'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(cx-120, cy+80); ctx.lineTo(cx+120, cy+80); ctx.stroke();
        } else if (currentTaskType === 'floors') {
            ctx.strokeStyle = 'rgba(39, 174, 96, 0.5)'; ctx.lineWidth = 1; ctx.setLineDash([5, 5]);
            for(let i=-3; i<=3; i++) { ctx.beginPath(); ctx.moveTo(cx+(i*60), 0); ctx.lineTo(cx+(i*60), canvas.height); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0, cy+(i*60)); ctx.lineTo(canvas.width, cy+(i*60)); ctx.stroke(); }
        }
        
        updateInspectionUI();
        requestAnimationFrame(renderOverlays);
    }

    function updateInspectionUI() {
        const room = roomsData[currentRoomIdx];
        const labels = { walls: 'ÙØ­Øµ Ø§Ù„Ø²ÙˆØ§ÙŠØ§', bins: 'ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Ù„', vents: 'ÙØ­Øµ Ø§Ù„ØªÙ‡ÙˆÙŠØ©', floors: 'ÙØ­Øµ Ø§Ù„Ø£Ø±Ø¶ÙŠØ©' };
        document.getElementById('ui-room-name').innerText = room.name;
        document.getElementById('ui-task-name').innerText = labels[currentTaskType];
        document.getElementById('ui-counter').innerText = `(${taskCounter} Ù…Ù† ${room[currentTaskType]})`;
    }

    function captureAndLogic() {
        const isPass = Math.random() > 0.4;
        const room = roomsData[currentRoomIdx];
        if (!isPass) violations.push({ room: room.name, item: document.getElementById('ui-task-name').innerText, count: taskCounter });
        
        if (taskCounter < room[currentTaskType]) { taskCounter++; } 
        else {
            const types = ['walls', 'bins', 'vents', 'floors'];
            let idx = types.indexOf(currentTaskType);
            if (idx < 3) { currentTaskType = types[idx+1]; taskCounter = 1; } 
            else if (currentRoomIdx < roomsData.length - 1) { currentRoomIdx++; currentTaskType = 'walls'; taskCounter = 1; } 
            else { showFinalReport(); }
        }
    }

    function showFinalReport() {
        document.getElementById('inspectionScreen').classList.remove('active-screen');
        document.getElementById('reportScreen').classList.add('active-screen');
        document.getElementById('violationList').innerHTML = violations.map(v => `<div class="violation-card"><strong>ğŸ“ ${v.room}</strong><br>Ù…Ø®Ø§Ù„ÙØ© ÙÙŠ ${v.item} Ø±Ù‚Ù… ${v.count}<div style="width:100%; height:100px; background:#ddd; margin-top:10px; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#666; font-size:12px;">[ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©]</div></div>`).join('');
    }
</script>
</body>
</html>
