<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ù…Ù„ØªØ²Ù… â€” ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙØ­Øµ</title>

  <style>
    :root{
      --bg:#050607;
      --surface: rgba(20,24,28,.72);
      --text:#F5F7FA;
      --muted: rgba(245,247,250,.72);
      --primary:#0B5FFF;
      --accent:#19C37D;
      --warning:#F59E0B;
      --danger:#EF4444;
      --radius-xl:22px;
      --radius-lg:16px;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --hairline: rgba(255,255,255,.12);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }
    .stage{position:relative;width:100vw;height:100vh;background:#000;}
    #video{position:absolute; inset:0;width:100%;height:100%;object-fit:cover;}
    #captureCanvas{display:none;}
    #overlay{position:absolute; inset:0;width:100%;height:100%;pointer-events:none;}
    .topbar{
      position:absolute; top:0; left:0; right:0;
      padding: calc(14px + var(--safe-top)) 16px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      z-index:10;
      background: linear-gradient(180deg, rgba(0,0,0,.75) 0%, rgba(0,0,0,0) 100%);
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background: linear-gradient(135deg, rgba(11,95,255,.95), rgba(25,195,125,.95));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
    }
    .titleWrap{display:flex; flex-direction:column; min-width:0;}
    .title{font-size:15px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .subtitle{font-size:12px;color:var(--muted);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .topActions{display:flex; align-items:center; gap:10px;}
    .iconBtn{
      border:1px solid var(--hairline);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      font-weight:800;
      font-size:13px;
    }
    .iconBtn:active{transform:scale(.98);}
    .hint{
      position:absolute;
      top: calc(82px + var(--safe-top));
      left:50%; transform: translateX(-50%);
      z-index:10;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--hairline);
      background: rgba(20,24,28,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 35px rgba(0,0,0,.45);
      max-width:92vw;
      text-align:center;
      font-size:14px;
    }
    .cvPill{
      position:absolute;
      top: calc(128px + var(--safe-top));
      left:50%; transform: translateX(-50%);
      z-index:10;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--hairline);
      background: rgba(20,24,28,.62);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-weight:900;
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 35px rgba(0,0,0,.45);
      max-width:92vw;
    }
    .cvDot{width:10px;height:10px;border-radius:999px;background: var(--warning);}
    .cvVals{color: var(--muted); font-weight:800;}
    .sheet{
      position:absolute; left:0; right:0; bottom:0;
      padding:10px 14px calc(14px + var(--safe-bottom));
      z-index:10;
      background: linear-gradient(0deg, rgba(0,0,0,.92) 0%, rgba(0,0,0,0) 100%);
    }
    .sheetCard{
      border: 1px solid var(--hairline);
      background: rgba(20,24,28,.56);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--radius-xl);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .types{
      display:flex; gap:10px; overflow-x:auto; padding: 6px 4px 10px;
      scrollbar-width:none;
    }
    .types::-webkit-scrollbar{display:none;}
    .chip{
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 850;
      cursor:pointer;
      white-space:nowrap;
      transition:.18s ease;
      display:flex; align-items:center; gap:8px;
    }
    .chip.active{
      background: rgba(11,95,255,.22);
      border-color: rgba(11,95,255,.65);
      box-shadow: 0 12px 30px rgba(11,95,255,.14);
    }
    .chip:active{transform:scale(.98);}
    .captureRow{
      display:grid;
      grid-template-columns: 46px 1fr 46px;
      gap:12px;
      padding: 6px 4px 2px;
      align-items:center;
    }
    .miniBtn{
      width:46px;height:46px;border-radius:16px;
      border:1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
    }
    .miniBtn:active{transform:scale(.98);}
    .capture{
      width:100%;
      height:50px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(135deg, rgba(11,95,255,.92), rgba(25,195,125,.92));
      color:#fff;
      box-shadow: 0 18px 45px rgba(0,0,0,.55);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:15px;
      font-weight:900;
      transition: opacity .2s ease;
      gap:10px;
    }
    .capture.processing{opacity:.65;pointer-events:none;filter: grayscale(.35);}
    .capture:active{transform:scale(.99);}

    .perm{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:22px;
      background:
        radial-gradient(1000px 800px at 70% 20%, rgba(11,95,255,.22), transparent 55%),
        radial-gradient(900px 700px at 20% 70%, rgba(25,195,125,.18), transparent 55%),
        #070A0E;
      z-index:100;
    }
    .permCard{
      width: min(420px, 92vw);
      border-radius: 26px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--hairline);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 22px;
      box-shadow: var(--shadow);
      text-align:center;
    }
    .permCard h2{font-size:18px;margin-top:12px;}
    .permCard p{color: var(--muted); margin-top:10px; line-height:1.7; font-size:14px;}
    .primaryBtn{
      margin-top:16px;
      width:100%;
      border:none;
      background: var(--primary);
      color:#fff;
      font-weight:900;
      padding:14px 16px;
      border-radius:16px;
      cursor:pointer;
      box-shadow: 0 18px 35px rgba(11,95,255,.25);
      font-size:15px;
    }
    .primaryBtn:active{transform:scale(.99);}

    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.92);
      z-index:200;
      display:none;
      padding: calc(14px + var(--safe-top)) 14px calc(14px + var(--safe-bottom));
    }
    .modal.active{display:flex;flex-direction:column;gap:12px;}
    .modalHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid var(--hairline);
      background: rgba(20,24,28,.56);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .modalHeader strong{font-size:15px;}
    .closeBtn{
      border:1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      border-radius:14px;
      cursor:pointer;
    }
    .modalBody{
      flex:1;
      overflow:auto;
      border-radius:22px;
      border:1px solid var(--hairline);
      background: rgba(20,24,28,.56);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding:14px;
    }
    .preview{
      width:100%;
      border-radius:18px;
      border:1px solid var(--hairline);
      margin-bottom:14px;
      display:block;
    }
    .card{
      border-radius:18px;
      border:1px solid var(--hairline);
      background: rgba(255,255,255,.06);
      padding:14px;
    }
    .statusRow{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .badge{
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      border:1px solid var(--hairline);
      display:inline-flex;align-items:center;gap:8px;
    }
    .badge.ok{background: rgba(25,195,125,.14); border-color: rgba(25,195,125,.45);}
    .badge.no{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.45);}
    .badge.maybe{background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.45);}
    .meta{color:var(--muted);font-size:13px;margin-top:10px;}
    .bar{
      height:10px;border-radius:999px;background: rgba(255,255,255,.10);
      margin-top:10px;overflow:hidden;border:1px solid var(--hairline);
    }
    .fill{height:100%;width:0%;transition:width 600ms ease;}
    .msg{margin-top:12px;color: rgba(245,247,250,.9);line-height:1.7;font-size:14px;}
    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .ghost{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 14px;
      border-radius:16px;
      font-weight:900;
      cursor:pointer;
    }
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: calc(110px + var(--safe-bottom));
      z-index:300;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--hairline);
      background: rgba(20,24,28,.72);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: var(--text);
      font-size:13px;
      display:none;
      max-width:92vw;
      text-align:center;
      box-shadow: 0 16px 50px rgba(0,0,0,.55);
    }
    .toast.show{display:block;}
  </style>

  <!-- EmailJS (Ù„Ù„ØªØ¬Ø±Ø¨Ø©) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- OpenCV.js (Computer Vision) -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
</head>

<body>

  <div id="perm" class="perm">
    <div class="permCard">
      <div style="font-size:64px">ğŸ“·</div>
      <h2 id="permTitle">Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø·Ù„ÙˆØ¨</h2>
      <p id="permDesc">
        Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø«Ù… Ø§ÙƒØªØ´Ø§Ù Ø®Ø· Ø§Ù„Ø£Ø±Ø¶ ÙˆØ®Ø· Ø§Ù„Ø¬Ø¯Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Computer Vision)
        ÙˆØ­Ø³Ø§Ø¨ Ø²Ø§ÙˆÙŠØ© Ø§Ù„ØªÙ‚Ø§Ø·Ø¹ Ø¨ÙŠÙ†Ù‡Ù…Ø§.
      </p>
      <button class="primaryBtn" id="permBtn">Ø§Ù„Ø³Ù…Ø§Ø­ ÙˆØ§Ù„Ø¨Ø¯Ø¡</button>
      <p style="margin-top:12px; font-size:12px; color: var(--muted);">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø®Ø·ÙˆØ· ÙŠØ­ØªØ§Ø¬ ØªØ¨Ø§ÙŠÙ† ÙˆØ§Ø¶Ø­ (Ø­Ø§ÙØ© Ø§Ù„Ø¬Ø¯Ø§Ø±/Ø§Ù„Ø£Ø±Ø¶ + Ø¥Ø¶Ø§Ø¡Ø© ÙƒØ§ÙÙŠØ©).
      </p>
    </div>
  </div>

  <div class="stage" id="stage" style="display:none;">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="captureCanvas"></canvas>
    <canvas id="overlay"></canvas>

    <div class="topbar">
      <div class="brand">
        <div class="logo">Ù…</div>
        <div class="titleWrap">
          <div class="title" id="appTitle">Ù…Ù„ØªØ²Ù… â€” ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙØ­Øµ</div>
          <div class="subtitle" id="appSub">ÙØ­Øµ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯Ø§Ø±/Ø§Ù„Ø£Ø±Ø¶ â€” Computer Vision</div>
        </div>
      </div>
      <div class="topActions">
        <button class="iconBtn" id="langBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©">ğŸŒ <span id="langLabel">EN</span></button>
      </div>
    </div>

    <div class="hint" id="hint">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø²Ø§ÙˆÙŠØ© Ø§Ù„ØªÙ‚Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø¨Ø§Ù„Ø£Ø±Ø¶ (Ø§Ù„Ø­Ø§ÙØ© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø©)</div>

    <div class="cvPill" id="cvPill">
      <span id="cvDot" class="cvDot"></span>
      <span id="cvText">Ø¬Ø§Ù‡Ø² â€” Ø§Ø¶ØºØ· â€œØ§Ù„ØªÙ‚Ø§Ø· + ØªØ­Ù„ÙŠÙ„â€</span>
      <span id="cvVals" class="cvVals"></span>
    </div>

    <div class="sheet">
      <div class="sheetCard">
        <div class="types" id="types">
          <button class="chip active" data-type="4.5">ğŸ“ Ø²ÙˆØ§ÙŠØ§ 45Â°</button>
          <button class="chip" data-type="4.7">ğŸŒ¬ï¸ Ø§Ù„ØªÙ‡ÙˆÙŠØ©</button>
          <button class="chip" data-type="5.8">ğŸ—‘ï¸ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª</button>
          <button class="chip" data-type="defects">ğŸ”§ Ø§Ù„Ø¹ÙŠÙˆØ¨</button>
        </div>

        <div class="captureRow">
          <button class="miniBtn" id="switchBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">ğŸ”„</button>
          <button class="capture" id="captureBtn" title="Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØªØ­Ù„ÙŠÙ„">
            ğŸ“· <span id="capLabel">Ø§Ù„ØªÙ‚Ø§Ø· + ØªØ­Ù„ÙŠÙ„</span>
          </button>
          <button class="miniBtn" id="stopBtn" title="Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">â»</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modalHeader">
      <strong id="modalTitle">Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ</strong>
      <button class="closeBtn" id="modalClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
    </div>

    <div class="modalBody">
      <img id="preview" class="preview" alt="Captured" />
      <div class="card">
        <div class="statusRow">
          <div id="badge" class="badge maybe">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„</div>
          <div style="text-align:left">
            <div style="font-weight:900" id="ruleLabel">Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© 4.5</div>
            <div class="meta" id="confText">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©: â€”</div>
          </div>
        </div>

        <div class="bar"><div class="fill" id="fill"></div></div>
        <div class="msg" id="msg">ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø§ÙˆÙŠØ©â€¦</div>

        <div class="actions">
          <button class="ghost" id="retryBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
          <button class="primaryBtn" id="newBtn" style="margin:0;">ÙØ­Øµ Ø¬Ø¯ÙŠØ¯</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   EmailJS Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¹Ø¯Ù‘Ù„Ù‡Ø§)
   ========================= */
const EMAILJS_PUBLIC_KEY  = "PUT_YOUR_PUBLIC_KEY_HERE";
const EMAILJS_SERVICE_ID  = "PUT_YOUR_SERVICE_ID_HERE";
const EMAILJS_TEMPLATE_ID = "PUT_YOUR_TEMPLATE_ID_HERE";
const EMAIL_TO = "a.alamm@datainsight.com.sa";
emailjs.init(EMAILJS_PUBLIC_KEY);

/* =========================
   State
   ========================= */
let stream = null;
let currentLang = 'ar';
let selectedType = '4.5';
let facingMode = 'environment';
let lastBlob = null;

// Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø© CV
let lastCV = null; // { angleDeg, confidence, hLine, vLine, intersection, status }

/* =========================
   Translations
   ========================= */
const TT = {
  ar: {
    appTitle: 'Ù…Ù„ØªØ²Ù… â€” ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙØ­Øµ',
    appSub: 'ÙØ­Øµ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯Ø§Ø±/Ø§Ù„Ø£Ø±Ø¶ â€” Computer Vision',
    hint: 'ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø²Ø§ÙˆÙŠØ© Ø§Ù„ØªÙ‚Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø¨Ø§Ù„Ø£Ø±Ø¶ (Ø§Ù„Ø­Ø§ÙØ© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø©)',
    cap: 'Ø§Ù„ØªÙ‚Ø§Ø· + ØªØ­Ù„ÙŠÙ„',
    modalTitle: 'Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ',
    retry: 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„',
    newScan: 'ÙØ­Øµ Ø¬Ø¯ÙŠØ¯',
    close: 'Ø¥ØºÙ„Ø§Ù‚ âœ•',
    lang: 'EN',
    rule: (x)=> x==='defects' ? 'ÙØ­Øµ Ø§Ù„Ø¹ÙŠÙˆØ¨' : `Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ${x}`,
    ready: 'Ø¬Ø§Ù‡Ø² â€” Ø§Ø¶ØºØ· â€œØ§Ù„ØªÙ‚Ø§Ø· + ØªØ­Ù„ÙŠÙ„â€',
    cvWorking: 'Ø¬Ø§Ø±ÙŠ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø®Ø·ÙˆØ·â€¦',
    cvOk: (a)=> `ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø²Ø§ÙˆÙŠØ©: ${a.toFixed(1)}Â°`,
    cvFail: 'Ù„Ù… Ù†Ù†Ø¬Ø­ ÙÙŠ Ø§ÙƒØªØ´Ø§Ù Ø®Ø·ÙŠÙ† ÙˆØ§Ø¶Ø­ÙŠÙ†. Ù‚Ø±Ù‘Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ© ÙˆØ²Ø¯ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©.',
    emailSent: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ âœ…',
    emailFail: 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ EmailJS.',
    cameraFail: 'ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†.',
    captureFail: 'ÙØ´Ù„ Ø§Ù„ØªÙ‚Ø§Ø·/ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.',
    needCV: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© ØªØ­Ù„ÙŠÙ„ Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§.',
    rule45: 'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø²Ø§ÙˆÙŠØ© 45Â°',
    compliant: 'Ù…Ø·Ø§Ø¨Ù‚',
    noncompliant: 'ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚',
    uncertain: 'ØºÙŠØ± Ù…Ø¤ÙƒØ¯'
  },
  en: {
    appTitle: 'Multazim â€” Inspection Camera',
    appSub: 'Wall/Floor Angle â€” Computer Vision',
    hint: 'Point the camera at the wall/floor edge (keep the edge centered)',
    cap: 'Capture + Analyze',
    modalTitle: 'Inspection Result',
    retry: 'Retry',
    newScan: 'New Scan',
    close: 'Close âœ•',
    lang: 'AR',
    rule: (x)=> x==='defects' ? 'Defects Scan' : `Rule ${x}`,
    ready: 'Ready â€” tap â€œCapture + Analyzeâ€',
    cvWorking: 'Detecting linesâ€¦',
    cvOk: (a)=> `Angle detected: ${a.toFixed(1)}Â°`,
    cvFail: 'Could not find two clear lines. Move closer to the edge and improve lighting.',
    emailSent: 'Result emailed âœ…',
    emailFail: 'Email failed. Check EmailJS setup.',
    cameraFail: 'Unable to start camera. Please grant permission.',
    captureFail: 'Capture/analyze failed.',
    needCV: 'No analysis result available.',
    rule45: 'Validate 45Â° angle',
    compliant: 'Compliant',
    noncompliant: 'Non-Compliant',
    uncertain: 'Uncertain'
  }
};

/* =========================
   UI helpers
   ========================= */
function toast(msg){
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(()=> el.classList.remove('show'), 2500);
}

function setTexts(){
  const L = TT[currentLang];
  document.documentElement.lang = currentLang;
  document.documentElement.dir  = currentLang==='ar' ? 'rtl' : 'ltr';

  document.getElementById('appTitle').textContent = L.appTitle;
  document.getElementById('appSub').textContent   = L.appSub;
  document.getElementById('hint').textContent     = L.hint;
  document.getElementById('modalTitle').textContent = L.modalTitle;
  document.getElementById('retryBtn').textContent = L.retry;
  document.getElementById('newBtn').textContent   = L.newScan;
  document.getElementById('modalClose').textContent = L.close;
  document.getElementById('langLabel').textContent  = L.lang;
  document.getElementById('capLabel').textContent   = L.cap;
  document.getElementById('ruleLabel').textContent  = L.rule(selectedType);

  // Ø§Ù„Ø­Ø§Ù„Ø©
  setCVState('ready');
}

function setCVState(state, payload){
  const L = TT[currentLang];
  const dot = document.getElementById('cvDot');
  const txt = document.getElementById('cvText');
  const vals = document.getElementById('cvVals');

  if(state === 'ready'){
    dot.style.background = 'var(--warning)';
    txt.textContent = L.ready;
    vals.textContent = '';
  } else if(state === 'working'){
    dot.style.background = 'var(--warning)';
    txt.textContent = L.cvWorking;
    vals.textContent = '';
  } else if(state === 'ok'){
    dot.style.background = 'var(--accent)';
    txt.textContent = L.cvOk(payload.angleDeg);
    vals.textContent = (currentLang==='ar')
      ? `Ø«Ù‚Ø©: ${(payload.confidence*100).toFixed(0)}%`
      : `Conf: ${(payload.confidence*100).toFixed(0)}%`;
  } else if(state === 'fail'){
    dot.style.background = 'var(--danger)';
    txt.textContent = L.cvFail;
    vals.textContent = '';
  }
}

function openModalLoading(){
  const L = TT[currentLang];
  document.getElementById('modal').classList.add('active');
  document.getElementById('badge').className = 'badge maybe';
  document.getElementById('badge').textContent = currentLang==='ar' ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„' : 'â³ Analyzing';
  document.getElementById('confText').textContent = currentLang==='ar' ? 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©: â€”' : 'Confidence: â€”';
  document.getElementById('fill').style.width = '0%';
  document.getElementById('fill').style.background = 'linear-gradient(90deg, rgba(245,158,11,.9), rgba(11,95,255,.9))';
  document.getElementById('msg').textContent = currentLang==='ar'
    ? 'ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø§ÙˆÙŠØ©â€¦'
    : 'Extracting lines and computing angleâ€¦';
  document.getElementById('ruleLabel').textContent = L.rule(selectedType);
}

function closeModal(){
  document.getElementById('modal').classList.remove('active');
  const img = document.getElementById('preview');
  if(img.src.startsWith('blob:')) URL.revokeObjectURL(img.src);
  img.src = '';
}

function showResultUI(res){
  const fill = document.getElementById('fill');
  const badge = document.getElementById('badge');
  const confText = document.getElementById('confText');
  const msg = document.getElementById('msg');

  const map = {
    compliant: { cls:'ok', color:'linear-gradient(90deg, rgba(25,195,125,.95), rgba(11,95,255,.65))',
      labelAr:'âœ“ Ù…Ø·Ø§Ø¨Ù‚', labelEn:'âœ“ Compliant' },
    'non-compliant': { cls:'no', color:'linear-gradient(90deg, rgba(239,68,68,.95), rgba(245,158,11,.55))',
      labelAr:'âœ• ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚', labelEn:'âœ• Non-Compliant' },
    uncertain: { cls:'maybe', color:'linear-gradient(90deg, rgba(245,158,11,.95), rgba(11,95,255,.55))',
      labelAr:'ØŸ ØºÙŠØ± Ù…Ø¤ÙƒØ¯', labelEn:'ï¼Ÿ Uncertain' }
  };

  const m = map[res.status];
  badge.className = 'badge ' + m.cls;
  badge.textContent = (currentLang==='ar') ? m.labelAr : m.labelEn;

  confText.textContent = (currentLang==='ar')
    ? `Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©: ${(res.confidence*100).toFixed(0)}%`
    : `Confidence: ${(res.confidence*100).toFixed(0)}%`;

  fill.style.background = m.color;
  requestAnimationFrame(()=> { fill.style.width = Math.round(res.confidence*100) + '%'; });

  msg.textContent = res.message;
}

/* =========================
   Camera
   ========================= */
async function startCamera(){
  stopCamera();
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode, width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    const video = document.getElementById('video');
    video.srcObject = stream;

    document.getElementById('perm').style.display = 'none';
    document.getElementById('stage').style.display = 'block';

    await video.play();
    resizeOverlay();
    drawOverlayLoop();

    setCVState('ready');
  }catch(e){
    toast(TT[currentLang].cameraFail);
    console.error(e);
  }
}

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(tr=> tr.stop());
    stream = null;
  }
}

document.getElementById('permBtn').addEventListener('click', startCamera);

/* =========================
   Overlay drawing (live)
   - ÙŠØ±Ø³Ù… Ø¥Ø±Ø´Ø§Ø¯Ø§Øª + Ø¥Ù† ØªÙˆÙØ±Øª Ù†ØªÙŠØ¬Ø© CV ÙŠØ±Ø³Ù… Ø§Ù„Ø®Ø·ÙŠÙ† + Ø§Ù„Ù…Ø«Ù„Ø«
   ========================= */
let rafId = null;

function resizeOverlay(){
  const overlay = document.getElementById('overlay');
  const rect = overlay.getBoundingClientRect();
  overlay.width = Math.floor(rect.width * devicePixelRatio);
  overlay.height = Math.floor(rect.height * devicePixelRatio);
}

function drawOverlayLoop(){
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');

  const loop = ()=>{
    const w = overlay.width, h = overlay.height;
    ctx.clearRect(0,0,w,h);

    // Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø®ÙÙŠÙØ©
    drawGuide(ctx, selectedType);

    // Ø¥Ø°Ø§ Ù„Ø¯ÙŠÙ†Ø§ Ù†ØªÙŠØ¬Ø© CVØŒ Ø§Ø±Ø³Ù… Ø§Ù„Ø®Ø·ÙŠÙ† + Ø§Ù„Ù…Ø«Ù„Ø« Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¥Ø·Ø§Ø± (ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹)
    if(lastCV && lastCV.hLine && lastCV.vLine && lastCV.intersection){
      drawDetectedGeometry(ctx, lastCV);
    }
    rafId = requestAnimationFrame(loop);
  };
  loop();
}

function stopOverlayLoop(){
  if(rafId) cancelAnimationFrame(rafId);
  rafId = null;
}

function drawGuide(ctx, type){
  const w = ctx.canvas.width;
  const h = ctx.canvas.height;
  const cx = w/2, cy = h/2;

  ctx.save();
  ctx.shadowColor = 'rgba(0,0,0,.55)';
  ctx.shadowBlur = 10;

  ctx.strokeStyle = 'rgba(11,95,255,.25)';
  ctx.lineWidth = 2;

  // Ø¥Ø·Ø§Ø± ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø© Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø­Ùˆ Ø§Ù„Ø­Ø§ÙØ©
  const rw = w * 0.68;
  const rh = h * 0.36;
  ctx.beginPath();
  roundRect(ctx, cx-rw/2, cy-rh/2, rw, rh, 24);
  ctx.stroke();

  // Ø®Ø·ÙˆØ· Ø¥Ø±Ø´Ø§Ø¯
  ctx.strokeStyle = 'rgba(25,195,125,.18)';
  ctx.beginPath();
  ctx.moveTo(cx, cy-rh/2); ctx.lineTo(cx, cy+rh/2);
  ctx.moveTo(cx-rw/2, cy); ctx.lineTo(cx+rw/2, cy);
  ctx.stroke();

  ctx.restore();
}

function drawDetectedGeometry(ctx, cvRes){
  // cvRes line coords are in "capture image space". We map them to overlay space
  // Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ø¨ÙŠÙ† captureCanvas Ùˆ overlay
  const overlay = ctx.canvas;
  const map = cvRes.map; // {sx, sy}
  if(!map) return;

  const toO = (pt)=> ({ x: pt.x * map.sx, y: pt.y * map.sy });

  const h1 = toO(cvRes.hLine.p1), h2 = toO(cvRes.hLine.p2);
  const v1 = toO(cvRes.vLine.p1), v2 = toO(cvRes.vLine.p2);
  const I  = toO(cvRes.intersection);

  ctx.save();
  ctx.lineWidth = 6;
  ctx.lineCap = 'round';
  ctx.shadowColor = 'rgba(0,0,0,.6)';
  ctx.shadowBlur = 10;

  // Ø§Ù„Ø®Ø· Ø§Ù„Ø£ÙÙ‚ÙŠ (Ø§Ù„Ø£Ø±Ø¶)
  ctx.strokeStyle = 'rgba(25,195,125,.95)';
  ctx.beginPath(); ctx.moveTo(h1.x,h1.y); ctx.lineTo(h2.x,h2.y); ctx.stroke();

  // Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ (Ø§Ù„Ø¬Ø¯Ø§Ø±)
  ctx.strokeStyle = 'rgba(11,95,255,.95)';
  ctx.beginPath(); ctx.moveTo(v1.x,v1.y); ctx.lineTo(v2.x,v2.y); ctx.stroke();

  // Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙ‚Ø§Ø·Ø¹
  ctx.fillStyle = 'rgba(245,247,250,.95)';
  ctx.beginPath(); ctx.arc(I.x, I.y, 7, 0, Math.PI*2); ctx.fill();

  // Ù…Ø«Ù„Ø« (Ø¶Ù„Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ + Ø¶Ù„Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯Ø§Ø± + ÙˆØªØ± Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ† Ø¨Ø¹ÙŠØ¯ØªÙŠÙ† Ø«Ø§Ø¨ØªØ©)
  // Ù†Ø®ØªØ§Ø± Ù†Ù‚Ø·ØªÙŠÙ† Ø¹Ù„Ù‰ ÙƒÙ„ Ø®Ø· Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ Ø«Ø§Ø¨Øª Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø·Ø¹
  const len = Math.min(overlay.width, overlay.height) * 0.16;

  const dirH = norm({x:h2.x-h1.x, y:h2.y-h1.y});
  const dirV = norm({x:v2.x-v1.x, y:v2.y-v1.y});

  const A = { x: I.x + dirH.x * len, y: I.y + dirH.y * len };
  const B = { x: I.x + dirV.x * len, y: I.y + dirV.y * len };

  ctx.lineWidth = 4;
  ctx.strokeStyle = 'rgba(245,247,250,.85)';
  ctx.beginPath();
  ctx.moveTo(I.x, I.y);
  ctx.lineTo(A.x, A.y);
  ctx.lineTo(B.x, B.y);
  ctx.closePath();
  ctx.stroke();

  // Ù†Øµ Ø§Ù„Ø²Ø§ÙˆÙŠØ©
  ctx.shadowBlur = 0;
  ctx.fillStyle = 'rgba(245,247,250,.95)';
  ctx.font = '900 28px system-ui, Arial';
  ctx.textAlign = 'center';
  ctx.fillText(cvRes.angleDeg.toFixed(1) + 'Â°', I.x, I.y - 16);

  ctx.restore();
}

function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
}

/* =========================
   Computer Vision: OpenCV Hough lines
   ========================= */
function ensureCVReady(){
  return new Promise((resolve, reject)=>{
    const t0 = Date.now();
    const check = ()=>{
      if(typeof cv !== 'undefined' && cv.Mat){
        // Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ø³Ø® ØªØ­ØªØ§Ø¬ onRuntimeInitialized
        if(cv.onRuntimeInitialized){
          // Ø¥Ø°Ø§ ÙƒØ§Ù† runtime Ø¬Ø§Ù‡Ø²Ø§Ù‹
          resolve(true);
        } else {
          resolve(true);
        }
        return;
      }
      if(Date.now() - t0 > 8000) return reject(new Error("OpenCV load timeout"));
      requestAnimationFrame(check);
    };
    check();
  });
}

function captureFrameToCanvas(){
  const video = document.getElementById('video');
  const canvas = document.getElementById('captureCanvas');
  const ctx = canvas.getContext('2d');

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  return canvas;
}

function matFromCanvas(canvas){
  // OpenCV read
  return cv.imread(canvas);
}

function detectWallFloorAngle(canvas){
  // ÙŠØ±Ø¬Ø¹: {angleDeg, confidence, hLine, vLine, intersection, map}
  // map: Ù„ØªØ­ÙˆÙŠÙ„ Ù†Ù‚Ø§Ø· canvas Ø¥Ù„Ù‰ overlay

  const src = matFromCanvas(canvas);
  const w = src.cols, h = src.rows;

  // Preprocess
  const gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

  const blur = new cv.Mat();
  cv.GaussianBlur(gray, blur, new cv.Size(5,5), 0, 0, cv.BORDER_DEFAULT);

  const edges = new cv.Mat();
  // Canny thresholds ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ¦Ø§Øª
  cv.Canny(blur, edges, 60, 160);

  // HoughLinesP
  const lines = new cv.Mat();
  const rho = 1;
  const theta = Math.PI/180;
  const threshold = 80;
  const minLineLength = Math.min(w,h) * 0.25;
  const maxLineGap = 15;

  cv.HoughLinesP(edges, lines, rho, theta, threshold, minLineLength, maxLineGap);

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†
  const candidates = [];
  for(let i=0; i<lines.rows; i++){
    const x1 = lines.data32S[i*4+0];
    const y1 = lines.data32S[i*4+1];
    const x2 = lines.data32S[i*4+2];
    const y2 = lines.data32S[i*4+3];

    const dx = x2-x1, dy = y2-y1;
    const len = Math.hypot(dx,dy);
    if(len < minLineLength) continue;

    // Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø· Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø£ÙÙ‚
    let ang = Math.atan2(dy, dx) * 180 / Math.PI; // -180..180
    // Ø§Ø¬Ø¹Ù„Ù‡Ø§ 0..180
    if(ang < 0) ang += 180;

    // ÙˆØ²Ù†: Ø·ÙˆÙ„ + Ù‚Ø±Ø¨ Ù…Ù† Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© (Ù†Ø¹Ø·ÙŠ Ø§Ù„Ø£ÙØ¶Ù„ Ù„Ù„Ø­Ø§ÙØ© ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ)
    const mx = (x1+x2)/2, my = (y1+y2)/2;
    const centerScore = 1.0 - (Math.hypot(mx-w/2, my-h/2) / Math.hypot(w/2,h/2));
    const score = len * (0.75 + 0.25 * Math.max(0, centerScore));

    candidates.push({
      p1:{x:x1,y:y1}, p2:{x:x2,y:y2},
      len, ang, score
    });
  }

  // Ù…ØµÙ†Ù: Ø£ÙÙ‚ÙŠ Ù‚Ø±ÙŠØ¨ Ù…Ù† 0/180 (Ù…Ø«Ù„Ø§Ù‹ <=20Â° Ø£Ùˆ >=160Â°)ØŒ Ø¹Ù…ÙˆØ¯ÙŠ Ù‚Ø±ÙŠØ¨ Ù…Ù† 90 (Ù…Ø«Ù„Ø§Ù‹ 70..110)
  const H = candidates.filter(c => (c.ang <= 20 || c.ang >= 160)).sort((a,b)=>b.score-a.score);
  const V = candidates.filter(c => (c.ang >= 70 && c.ang <= 110)).sort((a,b)=>b.score-a.score);

  // ØªÙ†Ø¸ÙŠÙ
  src.delete(); gray.delete(); blur.delete(); edges.delete(); lines.delete();

  if(H.length === 0 || V.length === 0){
    return null;
  }

  // Ø§Ù„Ø£ÙØ¶Ù„
  const hLine = H[0];
  const vLine = V[0];

  // ØªÙ‚Ø§Ø·Ø¹ Ø§Ù„Ø®Ø·ÙŠÙ† (ÙƒØ®Ø·ÙŠÙ† Ù„Ø§ ÙƒÙ‚Ø·Ø¹)
  const inter = lineIntersection(hLine.p1, hLine.p2, vLine.p1, vLine.p2);
  if(!inter) return null;

  // Ø²Ø§ÙˆÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø§ØªØ¬Ø§Ù‡ÙŠÙ† (0..90)
  const u = direction(hLine.p1, hLine.p2);
  const v = direction(vLine.p1, vLine.p2);
  let angle = angleBetween(u, v); // 0..180
  angle = Math.min(angle, 180-angle); // 0..90

  // Confidence: ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø·ÙˆÙ„ Ø§Ù„Ø®Ø·ÙŠÙ† ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…ÙƒØªØ´ÙØ© (ØªÙ‚Ø±ÙŠØ¨ÙŠ)
  const strength = (hLine.len + vLine.len) / (Math.min(w,h) * 1.2);
  const density = Math.min(1, candidates.length / 40);
  const confidence = clamp(0.35 + 0.45*clamp(strength,0,1) + 0.20*density, 0, 0.98);

  return {
    angleDeg: angle,
    confidence,
    hLine: { p1:hLine.p1, p2:hLine.p2, ang:hLine.ang, len:hLine.len },
    vLine: { p1:vLine.p1, p2:vLine.p2, ang:vLine.ang, len:vLine.len },
    intersection: inter,
    rawCount: candidates.length
  };
}

function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

function direction(p1,p2){
  const dx = p2.x-p1.x, dy = p2.y-p1.y;
  const n = Math.hypot(dx,dy) || 1;
  return { x: dx/n, y: dy/n };
}

function angleBetween(u,v){
  const dot = u.x*v.x + u.y*v.y;
  const d = clamp(dot, -1, 1);
  return Math.acos(d) * 180 / Math.PI;
}

function lineIntersection(a,b,c,d){
  // ØªÙ‚Ø§Ø·Ø¹ Ø®Ø· AB Ù…Ø¹ CD
  const A1 = b.y - a.y;
  const B1 = a.x - b.x;
  const C1 = A1*a.x + B1*a.y;

  const A2 = d.y - c.y;
  const B2 = c.x - d.x;
  const C2 = A2*c.x + B2*c.y;

  const det = A1*B2 - A2*B1;
  if(Math.abs(det) < 1e-6) return null;

  const x = (B2*C1 - B1*C2) / det;
  const y = (A1*C2 - A2*C1) / det;
  return { x, y };
}

function norm(v){
  const n = Math.hypot(v.x,v.y) || 1;
  return { x:v.x/n, y:v.y/n };
}

/* =========================
   Rule evaluation (Rule 4.5 -> check ~45Â°)
   ========================= */
function evaluateRule(angleDeg, confidence){
  const L = TT[currentLang];

  // Ø§ÙØªØ±Ø§Ø¶ Ø¹Ù…Ù„ÙŠ: Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© 4.5 = Ø²Ø§ÙˆÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø© 45Â°
  if(selectedType === '4.5'){
    const target = 45;
    const tol = 3.0; // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ø³Ø©
    const diff = Math.abs(angleDeg - target);

    // Ù†Ø¬Ø¹Ù„ Ø§Ù„Ø­ÙƒÙ… Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø«Ù‚Ø© Ø£ÙŠØ¶Ø§Ù‹
    if(confidence < 0.55){
      return {
        status:'uncertain',
        confidence,
        message: (currentLang==='ar')
          ? `ØªÙ… Ø­Ø³Ø§Ø¨ Ø²Ø§ÙˆÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© ${angleDeg.toFixed(1)}Â° Ù„ÙƒÙ† Ø§Ù„Ø«Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø©. Ù‚Ø±Ù‘Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ­Ø³Ù‘Ù† Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©.`
          : `Angle ~${angleDeg.toFixed(1)}Â° but confidence is low. Move closer and improve lighting.`
      };
    }
    if(diff <= tol){
      return {
        status:'compliant',
        confidence,
        message: (currentLang==='ar')
          ? `âœ… ${L.rule45}: Ø§Ù„Ø²Ø§ÙˆÙŠØ© ${angleDeg.toFixed(1)}Â° Ø¶Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ÙŠØ© (Â±${tol}Â°).`
          : `âœ… ${L.rule45}: angle ${angleDeg.toFixed(1)}Â° within tolerance (Â±${tol}Â°).`
      };
    }
    return {
      status:'non-compliant',
      confidence,
      message: (currentLang==='ar')
        ? `âœ• ${L.rule45}: Ø§Ù„Ø²Ø§ÙˆÙŠØ© ${angleDeg.toFixed(1)}Â° Ø®Ø§Ø±Ø¬ Ø§Ù„Ø³Ù…Ø§Ø­ÙŠØ© (Â±${tol}Â°).`
        : `âœ• ${L.rule45}: angle ${angleDeg.toFixed(1)}Â° outside tolerance (Â±${tol}Â°).`
    };
  }

  // Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ (4.7/5.8/defects): Ù†Ø¹Ø±Ø¶ Ø²Ø§ÙˆÙŠØ© ÙÙ‚Ø· ÙƒÙ…Ø¹Ù„ÙˆÙ…Ø© + ØªØµÙ†ÙŠÙ "ØºÙŠØ± Ù…Ø¤ÙƒØ¯"
  return {
    status:'uncertain',
    confidence,
    message: (currentLang==='ar')
      ? `ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø²Ø§ÙˆÙŠØ© ØªÙ‚Ø§Ø·Ø¹ ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: ${angleDeg.toFixed(1)}Â°. Ù‡Ø°Ø§ Ø§Ù„ÙØ­Øµ Ù…Ø®ØµØµ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø²ÙˆØ§ÙŠØ§ 45Â° ÙÙ‚Ø·.`
      : `Detected intersection angle: ${angleDeg.toFixed(1)}Â°. This CV check is currently optimized for 45Â° only.`
  };
}

/* =========================
   Capture + Analyze
   ========================= */
async function captureAndAnalyze(){
  const btn = document.getElementById('captureBtn');
  const L = TT[currentLang];

  btn.classList.add('processing');
  setCVState('working');
  lastCV = null;

  try{
    await ensureCVReady();

    const canvas = captureFrameToCanvas();

    // ØµÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    lastBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.86));
    const url = URL.createObjectURL(lastBlob);
    document.getElementById('preview').src = url;

    openModalLoading();

    // CV detect
    const result = detectWallFloorAngle(canvas);

    // ØªØ¬Ù‡ÙŠØ² mapping Ø¥Ù„Ù‰ overlay
    if(result){
      const overlay = document.getElementById('overlay');
      const sx = overlay.width / canvas.width;
      const sy = overlay.height / canvas.height;
      result.map = { sx, sy };
    }

    if(!result){
      setCVState('fail');
      // UI result
      const resUI = {
        status:'uncertain',
        confidence: 0.35,
        message: (currentLang==='ar')
          ? 'Ù„Ù… Ù†Ù†Ø¬Ø­ ÙÙŠ Ø§ÙƒØªØ´Ø§Ù Ø®Ø·ÙŠÙ† ÙˆØ§Ø¶Ø­ÙŠÙ†. Ù‚Ø±Ù‘Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ© ÙˆØ²Ø¯ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©ØŒ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.'
          : 'Could not detect two clear lines. Move closer to the edge and improve lighting, then retry.'
      };
      showResultUI(resUI);
      lastCV = null;
      btn.classList.remove('processing');
      return;
    }

    // save + show
    lastCV = result;
    setCVState('ok', result);

    const resUI = evaluateRule(result.angleDeg, result.confidence);
    showResultUI(resUI);

    // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ÙƒÙ„ ÙØ­Øµ
    try{
      await sendResultEmail({
        ...resUI,
        angleDeg: result.angleDeg,
        rawCount: result.rawCount
      });
      toast(L.emailSent);
    }catch(err){
      console.error(err);
      toast(L.emailFail);
    }

  }catch(e){
    console.error(e);
    setCVState('fail');
    toast(L.captureFail);
  }finally{
    btn.classList.remove('processing');
  }
}

/* =========================
   EmailJS send
   ========================= */
async function sendResultEmail(uiRes){
  const L = TT[currentLang];

  if(!lastBlob || !uiRes){
    throw new Error(L.needCV);
  }

  if(!EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY.includes("PUT_") ||
     !EMAILJS_SERVICE_ID || EMAILJS_SERVICE_ID.includes("PUT_") ||
     !EMAILJS_TEMPLATE_ID || EMAILJS_TEMPLATE_ID.includes("PUT_")){
    throw new Error("EmailJS keys not set");
  }

  const ts = new Date();

  const payload = {
    to_email: EMAIL_TO,
    rule: L.rule(selectedType),
    rule_code: selectedType,
    status: uiRes.status,
    confidence: (uiRes.confidence*100).toFixed(0) + '%',
    message: uiRes.message,
    angle_deg: (typeof uiRes.angleDeg === 'number') ? uiRes.angleDeg.toFixed(2) : 'N/A',
    cv_lines_count: (typeof uiRes.rawCount === 'number') ? String(uiRes.rawCount) : 'N/A',
    timestamp: ts.toLocaleString(),
    lang: currentLang.toUpperCase()
  };

  return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, payload);
}

/* =========================
   Events
   ========================= */
document.getElementById('captureBtn').addEventListener('click', captureAndAnalyze);

document.getElementById('retryBtn').addEventListener('click', async ()=>{
  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ù‚Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (Ø£ÙØ¶Ù„)
  await captureAndAnalyze();
});

document.getElementById('newBtn').addEventListener('click', ()=>{
  closeModal();
});

document.getElementById('modalClose').addEventListener('click', closeModal);

document.getElementById('stopBtn').addEventListener('click', ()=>{
  stopOverlayLoop();
  stopCamera();
  lastCV = null;
  document.getElementById('stage').style.display = 'none';
  document.getElementById('perm').style.display = 'flex';
  setCVState('ready');
  toast(currentLang==='ar' ? 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.' : 'Camera stopped.');
});

document.getElementById('switchBtn').addEventListener('click', async ()=>{
  facingMode = (facingMode === 'environment') ? 'user' : 'environment';
  toast(currentLang==='ar'
    ? (facingMode==='environment' ? 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©' : 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©')
    : (facingMode==='environment' ? 'Rear camera' : 'Front camera')
  );
  lastCV = null;
  await startCamera();
});

document.getElementById('langBtn').addEventListener('click', ()=>{
  currentLang = (currentLang==='ar') ? 'en' : 'ar';
  setTexts();
});

document.getElementById('types').addEventListener('click', (e)=>{
  const btn = e.target.closest('.chip');
  if(!btn) return;
  selectedType = btn.dataset.type;
  document.querySelectorAll('.chip').forEach(b=>{
    b.classList.toggle('active', b.dataset.type===selectedType);
  });
  setTexts();
  lastCV = null; // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
});

window.addEventListener('resize', ()=>{
  resizeOverlay();
});

/* =========================
   Init
   ========================= */
setTexts();

// ØªÙ†Ø¨ÙŠÙ‡: OpenCV Ù‚Ø¯ ÙŠØªØ£Ø®Ø± Ø¨Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ù„Ø§ Ù…Ø´ÙƒÙ„Ø© â€” Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙŠÙ†ØªØ¸Ø± ensureCVReady()
</script>
</body>
</html>
