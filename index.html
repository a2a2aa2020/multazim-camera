<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ù†Ø¸Ø§Ù… Ù…Ù„ØªØ²Ù… â€” Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <style>
    :root {
      --primary: #0052CC; --secondary: #2C3E50; --accent: #27AE60; --danger: #E74C3C;
      --bg-white: #FFFFFF; --bg-light: #F8FAFC; --border: #E2E8F0;
      --text-main: #1E293B; --text-muted: #64748B;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: var(--bg-white); color: var(--text-main); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

    /* Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± */
    .overlay-screen { position: fixed; inset: 0; background: var(--bg-white); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; }
    .card { width: 100%; max-width: 400px; padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }

    /* Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
    .stage { flex: 1; position: relative; background: #000; overflow: hidden; }
    #video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    #overlay { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }

    /* Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠ */
    .controls-panel { background: var(--bg-white); padding: 15px 20px calc(15px + env(safe-area-inset-bottom)); border-top: 1px solid var(--border); }
    
    /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù‚ÙˆØ³ */
    .arc-tools { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; background: var(--bg-light); padding: 10px; border-radius: 12px; border: 1px solid var(--border); }
    .slider-box { flex: 1; }
    .slider-box input { width: 100%; accent-color: var(--primary); }
    .flip-btn { padding: 8px 12px; background: var(--bg-white); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }

    .type-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
    .type-btn { border: 1.5px solid var(--border); background: var(--bg-white); color: var(--text-muted); padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; white-space: nowrap; position: relative; }
    .type-btn.active { border-color: var(--primary); color: var(--primary); background: #F0F7FF; }
    .type-btn.completed::after { content: 'âœ“'; position: absolute; top: -5px; left: -5px; background: var(--accent); color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; }

    .action-row { display: flex; align-items: center; justify-content: space-around; }
    .btn-capture { width: 70px; height: 70px; border-radius: 50%; background: var(--primary); border: 4px solid #E0E7FF; cursor: pointer; }
    .btn-sub { width: 44px; height: 44px; border-radius: 10px; background: var(--bg-light); border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }

    /* Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
    .check-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
    .status-tag { padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
    .tag-pass { background: #E8F5E9; color: var(--accent); }
    .tag-fail { background: #FDEDEC; color: var(--danger); }
    .btn-main { background: var(--primary); color: #fff; border: none; padding: 16px; border-radius: 12px; font-weight: 700; width: 100%; margin-top: 20px; cursor: pointer; }
  </style>
</head>
<body>

  <div id="loginScreen" class="overlay-screen">
    <div style="text-align: center; margin-bottom: 25px;">
      <div style="width: 60px; height: 60px; background: var(--primary); border-radius: 14px; display: inline-flex; align-items: center; justify-content: center; color: white; font-size: 30px; font-weight: 900; margin-bottom: 15px;">Ù…</div>
      <h2 style="color: var(--secondary);">Ù†Ø¸Ø§Ù… Ù…Ù„ØªØ²Ù… Ù„Ù„Ø±Ù‚Ø§Ø¨Ø©</h2>
    </div>
    <div class="card">
      <div class="input-group" style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-muted); font-weight: 600;">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label>
        <input type="number" id="crNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„..." style="width: 100%; padding: 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-light); font-size: 16px; outline: none;">
      </div>
      <button onclick="startApp()" class="btn-main">Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø§Ù…Ù„</button>
    </div>
  </div>

  <div id="stage" class="stage" style="display: none;">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="controls" class="controls-panel" style="display: none;">
    
    <div id="arcTools" class="arc-tools">
      <div class="slider-box">
        <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:5px;">
          <span>Ø­Ø¬Ù… Ø§Ù„Ù‚ÙˆØ³</span>
          <span id="arcVal">80</span>
        </div>
        <input type="range" id="arcSlider" min="40" max="200" value="80">
      </div>
      <button class="flip-btn" onclick="flipArc()">
        â†”ï¸ Ø¹ÙƒØ³ Ø§Ù„Ø§ØªØ¬Ø§Ù‡
      </button>
    </div>

    <div class="type-scroll" id="typeSelector">
      <button class="type-btn active" id="btn-4.5" data-type="4.5">ğŸ“ Ø§Ù„Ø²ÙˆØ§ÙŠØ§ 4.5</button>
      <button class="type-btn" id="btn-4.7" data-type="4.7">ğŸŒ¬ï¸ Ø§Ù„ØªÙ‡ÙˆÙŠØ© 4.7</button>
      <button class="type-btn" id="btn-5.8" data-type="5.8">ğŸ—‘ï¸ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª 5.8</button>
      <button class="type-btn" id="btn-defects" data-type="defects">ğŸ” Ø§Ù„Ø¹ÙŠÙˆØ¨</button>
    </div>

    <div class="action-row">
      <button class="btn-sub" onclick="switchCamera()">ğŸ”„</button>
      <button class="btn-capture" onclick="logCheck()"></button>
      <button class="btn-sub" onclick="location.reload()">âœ•</button>
    </div>
  </div>

  <div id="reportModal" class="overlay-screen" style="display: none;">
    <h2 style="margin-bottom: 20px; color: var(--secondary);">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ</h2>
    <div class="card" style="max-width: 500px;">
      <div id="reportContent"></div>
      <div id="guidanceSection" style="margin-top: 15px; padding: 15px; background: #FFF9E6; border-right: 4px solid #F1C40F; font-size: 13px; border-radius: 0 8px 8px 0;"></div>
      <button class="btn-main" onclick="location.reload()">Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </div>
  </div>

<script>
  let stream, currentType = '4.5', coords = "24.71, 46.67";
  let arcSize = 80, arcFlip = 1; // 1 Ù„Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ø¯ÙŠØŒ -1 Ù„Ù„Ø¹ÙƒØ³
  let results = {};
  const names = {'4.5': 'Ø§Ù†Ø­Ù†Ø§Ø¡ Ø§Ù„Ø²ÙˆØ§ÙŠØ§', '4.7': 'Ø§Ù„ØªÙ‡ÙˆÙŠØ©', '5.8': 'Ø§Ù„Ù†ÙØ§ÙŠØ§Øª', 'defects': 'Ø§Ù„Ø¹ÙŠÙˆØ¨ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠØ©'};

  async function startApp() {
    if(!document.getElementById('crNumber').value) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„");
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    document.getElementById('video').srcObject = stream;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('stage').style.display = 'block';
    document.getElementById('controls').style.display = 'block';
    
    if (navigator.geolocation) navigator.geolocation.getCurrentPosition(p => coords = `${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`);
    
    resize();
    render();
  }

  function resize() {
    const c = document.getElementById('overlay');
    c.width = c.clientWidth * window.devicePixelRatio;
    c.height = c.clientHeight * window.devicePixelRatio;
  }

  function render() {
    const c = document.getElementById('overlay'), ctx = c.getContext('2d');
    const w = c.width, h = c.height, dpr = window.devicePixelRatio;
    const cx = w/2, cy = h/2;

    ctx.clearRect(0, 0, w, h);
    ctx.strokeStyle = '#0052CC'; ctx.lineWidth = 4 * dpr; ctx.setLineDash([15, 10]);

    if(currentType === '4.5') {
      const r = arcSize * dpr;
      ctx.save();
      ctx.translate(cx, cy);
      ctx.scale(arcFlip, 1); // Ø¹ÙƒØ³ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø±
      ctx.beginPath();
      ctx.moveTo(0, -r);
      ctx.arcTo(0, 0, r, 0, r);
      ctx.stroke();
      ctx.restore();
    } 
    else if(currentType === '4.7') ctx.strokeRect(cx - 100*dpr, cy - 50*dpr, 200*dpr, 100*dpr);
    else if(currentType === '5.8') { ctx.beginPath(); ctx.arc(cx, cy, 80*dpr, 0, Math.PI*2); ctx.stroke(); }
    else if(currentType === 'defects') { ctx.setLineDash([]); ctx.lineWidth = 1; for(let i=1; i<3; i++) { ctx.beginPath(); ctx.moveTo(w*i/3, 0); ctx.lineTo(w*i/3, h); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0, h*i/3); ctx.lineTo(w, h*i/3); ctx.stroke(); } }

    requestAnimationFrame(render);
  }

  function flipArc() { arcFlip *= -1; }

  document.getElementById('arcSlider').oninput = function() {
    arcSize = this.value;
    document.getElementById('arcVal').innerText = this.value;
  };

  document.getElementById('typeSelector').onclick = (e) => {
    const b = e.target.closest('.type-btn');
    if(!b) return;
    currentType = b.dataset.type;
    document.querySelectorAll('.type-btn').forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    document.getElementById('arcTools').style.display = currentType === '4.5' ? 'flex' : 'none';
  };

  function logCheck() {
    const isPass = confirm(`Ù‡Ù„ Ø¨Ù†Ø¯ (${names[currentType]}) Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø§Ø´ØªØ±Ø§Ø·Ø§ØªØŸ`);
    results[currentType] = isPass ? 'PASS' : 'FAIL';
    document.getElementById(`btn-${currentType}`).classList.add('completed');
    
    if (Object.keys(results).length === 4) showFinalReport();
    else alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©. Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø¨Ù†Ø¯ Ø§Ù„ØªØ§Ù„ÙŠ.");
  }

  function showFinalReport() {
    let html = `<p style="font-size:12px; margin-bottom:15px;"><b>Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„:</b> ${document.getElementById('crNumber').value}<br><b>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b> ğŸ“ ${coords}</p>`;
    let totalFails = 0;
    let guidanceText = "";

    const guidanceNotes = {
      '4.5': "ÙŠØ¬Ø¨ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø²ÙˆØ§ÙŠØ§ Ù„ØªÙƒÙˆÙ† Ù…Ù†Ø­Ù†ÙŠØ© Ø¨Ù…Ù‚Ø¯Ø§Ø± 4.5 Ø³Ù….",
      '4.7': "ØªØ­Ø³ÙŠÙ† Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‡ÙˆÙŠØ© ÙˆÙ†Ø¸Ø§ÙØ© Ø§Ù„ÙÙ„Ø§ØªØ±.",
      '5.8': "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø§ÙˆÙŠØ§Øª Ù†ÙØ§ÙŠØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØµØ­ÙŠØ©.",
      'defects': "Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹ÙŠÙˆØ¨ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠØ© ÙˆØ§Ù„ØªØ´Ù‚Ù‚Ø§Øª ÙÙˆØ±Ø§Ù‹."
    };

    Object.keys(results).forEach(key => {
      const pass = results[key] === 'PASS';
      html += `<div class="check-item"><span>${names[key]}</span><span class="status-tag ${pass?'tag-pass':'tag-fail'}">${pass?'Ù…Ø·Ø§Ø¨Ù‚':'ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚'}</span></div>`;
      if(!pass) { totalFails++; guidanceText += `â€¢ ${guidanceNotes[key]}<br>`; }
    });

    document.getElementById('reportContent').innerHTML = html;
    document.getElementById('guidanceSection').innerHTML = totalFails > 0 ? `<b>Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</b><br>${guidanceText}` : `<b>Ø§Ù„Ù†ØªÙŠØ¬Ø©:</b> Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹.`;
    document.getElementById('reportModal').style.display = 'flex';
  }

  async function switchCamera() { /* Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ */ }
  window.onresize = resize;
</script>
</body>
</html>
