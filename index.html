<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù…Ù„ØªØ²Ù… â€” ÙØ­Øµ Ù…ÙŠØ¯Ø§Ù†ÙŠ Ø¨Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø²</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; background:#000; color:#fff; font-family:system-ui; }
#hud {
  position:fixed; top:16px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.65);
  padding:12px 18px;
  border-radius:14px;
  z-index:10;
  text-align:center;
  max-width:92vw;
}
#controls {
  position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
  display:flex; gap:10px; z-index:10;
  flex-wrap:wrap;
  justify-content:center;
  width:92vw;
}
button {
  padding:14px 16px;
  font-size:14px;
  border-radius:14px;
  border:none;
  background:#0B5FFF;
  color:#fff;
  font-weight:700;
  flex:1 1 auto;
}
button.secondary { background:#444; }
</style>
</head>

<body>

<div id="hud">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ Ø«Ù… Ø§Ø¶ØºØ·: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø³Ø·Ø­</div>

<div id="controls">
  <button onclick="setMode('angle')">ğŸ“ Ø²Ø§ÙˆÙŠØ© Ø¬Ø¯Ø§Ø±/Ø£Ø±Ø¶</button>
  <button onclick="setMode('vent')">ğŸŒ¬ï¸ Ø§Ù„ØªÙ‡ÙˆÙŠØ©</button>
  <button onclick="setMode('trash')">ğŸ—‘ï¸ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª</button>
  <button onclick="setMode('floor')">â¬œ Ø§Ù„Ø£Ø±Ø¶ÙŠØ§Øª</button>
  <button class="secondary" onclick="capture()">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø³Ø·Ø­</button>
</div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.159/build/three.module.js";

let scene, camera, renderer;
let xrSession, refSpace, hitTestSource;
let lastPose = null;

let mode = null;
let floorNormal = null;

const hud = document.getElementById("hud");

init().catch(err => {
  console.error(err);
  alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ AR. ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ³ØªØ®Ø¯Ù… Chrome Ø¹Ù„Ù‰ Android ÙˆØ£Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² ÙŠØ¯Ø¹Ù… ARCore.");
});

async function init() {
  if (!navigator.xr) {
    alert("WebXR ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ø¬Ù‡Ø§Ø². Ø§Ø³ØªØ®Ø¯Ù… Chrome Ø¹Ù„Ù‰ Android.");
    return;
  }

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera();

  renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
  renderer.xr.enabled = true;
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const light = new THREE.HemisphereLight(0xffffff, 0x444444);
  scene.add(light);

  xrSession = await navigator.xr.requestSession("immersive-ar", {
    requiredFeatures: ["hit-test"]
  });

  renderer.xr.setSession(xrSession);

  refSpace = await xrSession.requestReferenceSpace("local");
  const viewerSpace = await xrSession.requestReferenceSpace("viewer");
  hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });

  renderer.setAnimationLoop(render);

  hud.innerText = "Ø¬Ø§Ù‡Ø² â€” Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ";
}

function render(_, frame) {
  if (!frame) return;
  const hits = frame.getHitTestResults(hitTestSource);
  if (hits.length > 0) lastPose = hits[0].getPose(refSpace);
  renderer.render(scene, camera);
}

window.setMode = function(m) {
  mode = m;
  floorNormal = null;

  if (m === "angle") hud.innerText = "ÙØ­Øµ Ø§Ù„Ø²Ø§ÙˆÙŠØ©: ÙˆØ¬Ù‘Ù‡ Ù„Ù„Ø£Ø±Ø¶ ÙˆØ§Ø¶ØºØ· ØªØ«Ø¨ÙŠØª Ø§Ù„Ø³Ø·Ø­";
  if (m === "vent") hud.innerText = "ÙØ­Øµ Ø§Ù„ØªÙ‡ÙˆÙŠØ©: ÙˆØ¬Ù‘Ù‡ Ù„Ù„Ø¬Ø¯Ø§Ø± Ù‚Ø±Ø¨ ÙØªØ­Ø© Ø§Ù„ØªÙ‡ÙˆÙŠØ© ÙˆØ§Ø¶ØºØ· ØªØ«Ø¨ÙŠØª Ø§Ù„Ø³Ø·Ø­";
  if (m === "trash") hud.innerText = "ÙØ­Øµ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª: ÙˆØ¬Ù‘Ù‡ Ù„Ù„Ø£Ø±Ø¶ Ù‚Ø±Ø¨ Ø³Ù„Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª ÙˆØ§Ø¶ØºØ· ØªØ«Ø¨ÙŠØª Ø§Ù„Ø³Ø·Ø­";
  if (m === "floor") hud.innerText = "ÙØ­Øµ Ø§Ù„Ø£Ø±Ø¶ÙŠØ§Øª: ÙˆØ¬Ù‘Ù‡ Ù„Ù„Ø£Ø±Ø¶ ÙˆØ§Ø¶ØºØ· ØªØ«Ø¨ÙŠØª Ø§Ù„Ø³Ø·Ø­";
};

window.capture = function() {
  if (!lastPose || !mode) {
    hud.innerText = "Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
    return;
  }

  const normal = getNormal(lastPose);

  if (mode === "angle") {
    if (!floorNormal) {
      floorNormal = normal;
      hud.innerText = "ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø±Ø¶ â€” Ø§Ù„Ø¢Ù† ÙˆØ¬Ù‘Ù‡ Ù„Ù„Ø¬Ø¯Ø§Ø± ÙˆØ§Ø¶ØºØ· ØªØ«Ø¨ÙŠØª Ø§Ù„Ø³Ø·Ø­";
    } else {
      const angle = angleBetween(floorNormal, normal);
      hud.innerText = `Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯Ø§Ø±/Ø§Ù„Ø£Ø±Ø¶ â‰ˆ ${angle.toFixed(1)}Â° (Ø§Ù„Ù…ÙØªØ±Ø¶ Ù‚Ø±ÙŠØ¨ Ù…Ù† 90Â°)`;
    }
  }

  if (mode === "vent") {
    const verticality = Math.abs(normal.y);
    hud.innerText = verticality < 0.3 ? "âœ”ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¬Ø¯Ø§Ø± Ø¹Ù…ÙˆØ¯ÙŠ ØµØ§Ù„Ø­ (Ù„Ù„ØªÙ‡ÙˆÙŠØ©)" : "âŒ Ø§Ù„Ø³Ø·Ø­ ØºÙŠØ± Ø¹Ù…ÙˆØ¯ÙŠ â€” Ù‚Ø±Ù‘Ø¨ Ù„Ù„Ø¬Ø¯Ø§Ø±";
  }

  if (mode === "trash") {
    const horizontality = Math.abs(normal.y);
    hud.innerText = horizontality > 0.9 ? "âœ”ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø£Ø±Ø¶ Ø£ÙÙ‚ÙŠØ© ØµØ§Ù„Ø­Ø© (Ø³Ù„Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª)" : "âŒ Ø§Ù„Ø³Ø·Ø­ ØºÙŠØ± Ø£ÙÙ‚ÙŠ â€” ÙˆØ¬Ù‘Ù‡ Ù„Ù„Ø£Ø±Ø¶";
  }

  if (mode === "floor") {
    const flatness = Math.abs(normal.y);
    hud.innerText = flatness > 0.95 ? "âœ”ï¸ Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ù…Ø³ØªÙˆÙŠØ©" : "âš ï¸ Ø§Ù„Ø£Ø±Ø¶ÙŠØ© ØºÙŠØ± Ù…Ø³ØªÙˆÙŠØ©";
  }
};

function getNormal(pose) {
  const q = pose.transform.orientation;
  const quat = new THREE.Quaternion(q.x, q.y, q.z, q.w);
  const normal = new THREE.Vector3(0, 1, 0);
  return normal.applyQuaternion(quat).normalize();
}

function angleBetween(a, b) {
  const dot = THREE.MathUtils.clamp(a.dot(b), -1, 1);
  return THREE.MathUtils.radToDeg(Math.acos(dot));
}

window.addEventListener("resize", () => {
  renderer?.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
