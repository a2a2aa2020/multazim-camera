<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ù…Ù„ØªØ²Ù… â€” ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…Ø·ÙˆØ±Ø©</title>

  <style>
    :root{
      --bg: #050607;
      --surface: rgba(20, 24, 28, .72);
      --text: #F5F7FA;
      --muted: rgba(245,247,250,.72);
      --primary: #0B5FFF;
      --accent: #19C37D;
      --hairline: rgba(255,255,255,.12);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --radius-xl: 22px;
    }

    *{ box-sizing: border-box; margin:0; padding:0; }
    body{
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    .stage{ position: relative; width: 100vw; height: 100vh; background: #000; }
    #video{ position:absolute; inset:0; width:100%; height:100%; object-fit: cover; }
    #overlay{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }
    #captureCanvas{ display:none; }

    /* Top bar */
    .topbar{
      position:absolute; top:0; left:0; right:0;
      padding: calc(14px + var(--safe-top)) 16px 12px;
      display:flex; align-items:center; justify-content: space-between;
      z-index: 10;
      background: linear-gradient(180deg, rgba(0,0,0,.75) 0%, rgba(0,0,0,0) 100%);
    }

    .logo{ width: 34px; height:34px; border-radius: 10px; background: linear-gradient(135deg, #0B5FFF, #19C37D); display:flex; align-items:center; justify-content:center; font-weight:800; }

    /* Slider UI - Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø­Ø¯ÙŠØ«Ø§Ù‹ */
    .sliderBox {
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      border: 1px solid var(--hairline);
    }
    input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; height: 6px; }

    /* Bottom sheet */
    .sheet{
      position:absolute; left:0; right:0; bottom:0;
      padding: 10px 14px calc(14px + var(--safe-bottom));
      z-index: 10;
    }

    .sheetCard{
      border: 1px solid var(--hairline);
      background: rgba(20,24,28,.6);
      backdrop-filter: blur(15px);
      border-radius: var(--radius-xl);
      padding: 15px;
    }

    .types{ display:flex; gap:10px; overflow-x:auto; padding-bottom: 12px; scrollbar-width: none; }
    .chip{
      border: 1px solid var(--hairline); background: rgba(255,255,255,.06); color: var(--text);
      padding: 10px 18px; border-radius: 999px; font-weight: 700; cursor:pointer; white-space: nowrap;
    }
    .chip.active{ background: var(--primary); border-color: var(--primary); }

    .captureRow{ display:flex; align-items:center; justify-content: space-between; padding-top: 5px;}
    .capture{
      width: 74px; height:74px; border-radius: 999px; border: 4px solid #fff;
      background: linear-gradient(135deg, #0B5FFF, #19C37D); cursor:pointer;
    }
    
    .miniBtn{ width: 44px; height:44px; border-radius: 14px; background: rgba(255,255,255,0.1); border: 1px solid var(--hairline); color: #fff; cursor: pointer; font-size: 18px; }

    /* Modal */
    .modal{ position:fixed; inset:0; background: rgba(0,0,0,.95); z-index: 200; display:none; padding: 20px; flex-direction: column; }
    .modal.active{ display:flex; }
    .preview{ width:100%; border-radius: 18px; border: 1px solid var(--hairline); margin-bottom: 15px; }
    
    .perm{ position:fixed; inset:0; background: #070A0E; display:flex; align-items:center; justify-content:center; z-index: 100; text-align:center; padding: 20px; }
    .primaryBtn{ background: var(--primary); color: #fff; border:none; padding: 16px; border-radius: 14px; font-weight: 800; width: 100%; cursor:pointer; }
  </style>
</head>

<body>

  <div id="perm" class="perm">
    <div style="width: 100%; max-width: 320px;">
      <div style="font-size: 50px; margin-bottom: 20px;">ğŸ“·</div>
      <h2 style="margin-bottom:10px;">Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ</h2>
      <p style="color:var(--muted); margin-bottom:20px; font-size: 14px;">ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø²ÙˆØ§ÙŠØ§.</p>
      <button class="primaryBtn" id="permBtn">ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    </div>
  </div>

  <div class="stage" id="stage" style="display:none;">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
    <canvas id="captureCanvas"></canvas>

    <div class="topbar">
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="logo">Ù…</div>
        <div>
          <div style="font-size:14px; font-weight:800;">Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø§Ù†Ø­Ù†Ø§Ø¡ (4.5)</div>
          <div style="font-size:11px; color:var(--muted);">Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø°ÙƒÙŠ</div>
        </div>
      </div>
    </div>

    <div class="sheet">
      <div class="sheetCard">
        
        <div id="sliderArea" class="sliderBox">
          <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:12px; font-weight: bold;">
            <span>Ø­Ø¬Ù… Ù‚ÙˆØ³ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</span>
            <span id="radiusVal" style="color:var(--accent)">80</span>
          </div>
          <input type="range" id="radiusSlider" min="30" max="220" value="80">
        </div>

        <div class="types" id="types">
          <button class="chip active" data-type="4.5">ğŸ“ Ø§Ù†Ø­Ù†Ø§Ø¡ Ø§Ù„Ø²Ø§ÙˆÙŠØ©</button>
          <button class="chip" data-type="defects">ğŸ” ÙØ­Øµ Ø¹Ø§Ù…</button>
        </div>

        <div class="captureRow">
          <button class="miniBtn" id="switchBtn">ğŸ”„</button>
          <button class="capture" id="captureBtn"></button>
          <button class="miniBtn" id="stopBtn">âœ•</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <h2 style="margin-bottom:15px; text-align: center;">Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù‚Ù‚</h2>
    <img id="preview" class="preview" />
    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:18px; border: 1px solid var(--hairline);">
      <div style="background:var(--accent); color:#000; padding:6px 12px; border-radius:20px; display:inline-block; font-weight:800; font-size:12px; margin-bottom:10px;">âœ“ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…ÙˆØ§ØµÙØ© 4.5</div>
      <p style="font-size:14px; line-height:1.6; color: var(--muted);">ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©. Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø£ÙƒØ¯ Ø§Ù†Ø­Ù†Ø§Ø¡ Ø§Ù„Ø±ÙƒÙ† Ø¨Ù…Ø§ ÙŠÙ…Ù†Ø¹ ØªØ±Ø§ÙƒÙ… Ø§Ù„Ø£ÙˆØ³Ø§Ø®.</p>
      <button class="primaryBtn" id="closeModal" style="margin-top:20px;">ÙØ­Øµ Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </div>

<script>
  let stream = null;
  let selectedType = '4.5';
  let currentRadius = 80;
  let facingMode = 'environment';

  // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
  async function startCamera() {
    try {
      if(stream) stream.getTracks().forEach(t => t.stop());
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode, width: { ideal: 1280 }, height: { ideal: 720 } }
      });
      document.getElementById('video').srcObject = stream;
      document.getElementById('perm').style.display = 'none';
      document.getElementById('stage').style.display = 'block';
      resizeOverlay();
      drawLoop();
    } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + e); }
  }

  function resizeOverlay() {
    const ov = document.getElementById('overlay');
    ov.width = window.innerWidth * window.devicePixelRatio;
    ov.height = window.innerHeight * window.devicePixelRatio;
  }

  // Ù…Ù†Ø·Ù‚ Ø±Ø³Ù… Ø§Ù„Ù‚ÙˆØ³ (Template)
  function drawGuide() {
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    const dpr = window.devicePixelRatio;

    ctx.clearRect(0, 0, w, h);
    
    if (selectedType === '4.5') {
      const cx = w / 2;
      const cy = h / 2;
      const r = currentRadius * dpr;

      ctx.save();
      
      // Ø±Ø³Ù… Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ø£Ø®Ø¶Ø±
      ctx.strokeStyle = '#19C37D';
      ctx.lineWidth = 5 * dpr;
      ctx.lineCap = 'round';
      ctx.setLineDash([15, 12]); // Ø®Ø· Ù…Ù‚Ø·Ø¹ Ø§Ø­ØªØ±Ø§ÙÙŠ
      
      ctx.beginPath();
      // Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø¬Ø¯Ø§Ø±)ØŒ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© (Ø§Ù„Ø±ÙƒÙ†)ØŒ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ø£Ø±Ø¶)
      ctx.moveTo(cx, cy - r);
      ctx.arcTo(cx, cy, cx + r, cy, r);
      ctx.stroke();

      // Ø±Ø³Ù… Ø§Ù„Ù…Ù…Ø§Ø³Ø§Øª Ø¨Ø®Ø· Ø¨Ø§Ù‡Øª Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø©
      ctx.setLineDash([]);
      ctx.strokeStyle = 'rgba(255,255,255,0.2)';
      ctx.lineWidth = 2 * dpr;
      ctx.beginPath();
      ctx.moveTo(cx, cy - r - 40); ctx.lineTo(cx, cy - r); 
      ctx.moveTo(cx + r, cy); ctx.lineTo(cx + r + 40, cy);
      ctx.stroke();
      
      ctx.restore();
    }
  }

  function drawLoop() {
    drawGuide();
    requestAnimationFrame(drawLoop);
  }

  // Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª (Events)
  document.getElementById('radiusSlider').addEventListener('input', (e) => {
    currentRadius = e.target.value;
    document.getElementById('radiusVal').textContent = currentRadius;
  });

  document.getElementById('captureBtn').addEventListener('click', async () => {
    const video = document.getElementById('video');
    const canvas = document.getElementById('captureCanvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    document.getElementById('preview').src = canvas.toDataURL('image/jpeg');
    document.getElementById('modal').classList.add('active');
  });

  document.getElementById('types').addEventListener('click', (e) => {
    const btn = e.target.closest('.chip');
    if(!btn) return;
    selectedType = btn.dataset.type;
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù†ÙˆØ¹ Ù‡Ùˆ 4.5
    document.getElementById('sliderArea').style.display = selectedType === '4.5' ? 'block' : 'none';
  });

  document.getElementById('permBtn').addEventListener('click', startCamera);
  document.getElementById('closeModal').addEventListener('click', () => {
    document.getElementById('modal').classList.remove('active');
  });
  document.getElementById('switchBtn').addEventListener('click', () => {
    facingMode = facingMode === 'environment' ? 'user' : 'environment';
    startCamera();
  });
  document.getElementById('stopBtn').addEventListener('click', () => location.reload());

  window.addEventListener('resize', resizeOverlay);
</script>
</body>
</html>
